# Server Operations - mise tasks
# This file is synced to /srv/studio/server-mise.toml via Ansible
#
# Usage on server:
#   mise tasks          # List all tasks
#   mise run <task>     # Run a task
#   m <task>            # Use alias

# ==================== Database Operations ====================

[tasks.db-restore-local]
description = "Restore PostgreSQL from latest local backup"
run = "cd /srv/studio/infra-apps/backup && docker compose run --rm backup /usr/local/bin/restore-postgres-local.sh latest"

[tasks.db-restore-s3]
description = "Restore PostgreSQL from latest S3 backup"
run = "cd /srv/studio/infra-apps/backup && docker compose run --rm backup /usr/local/bin/restore-postgres-s3.sh latest"

[tasks.db-list-local]
description = "List local backup files"
run = "ls -lh /data/backups/postgres/"

[tasks.db-list-s3]
description = "List S3 backups"
run = "cd /srv/studio/infra-apps/backup && docker compose run --rm backup /usr/local/bin/list-s3-postgres.sh"

[tasks.db-backup-now]
description = "Create backup now"
run = "cd /srv/studio/infra-apps/backup && docker compose run --rm backup /usr/local/bin/backup-postgres.sh"

# ==================== Application Management ====================

[tasks.app-logs]
alias = "logs"
description = "View application logs (follow)"
run = "cd /srv/studio/infra-apps/app && docker compose logs -f api"

[tasks.app-logs-tail]
description = "View last 100 lines of app logs"
run = "cd /srv/studio/infra-apps/app && docker compose logs --tail=100 api"

[tasks.app-restart]
alias = "restart"
description = "Restart application"
run = "cd /srv/studio/infra-apps/app && docker compose restart api"

[tasks.app-stop]
description = "Stop application"
run = "cd /srv/studio/infra-apps/app && docker compose stop api"

[tasks.app-start]
description = "Start application"
run = "cd /srv/studio/infra-apps/app && docker compose start api"

[tasks.app-shell]
description = "Enter application container shell"
run = "cd /srv/studio/infra-apps/app && docker compose exec api bash"

[tasks.app-ps]
alias = "ps"
description = "Show running containers"
run = "cd /srv/studio/infra-apps/app && docker compose ps"

# ==================== Infrastructure Services ====================

[tasks.postgres-logs]
description = "View PostgreSQL logs"
run = "cd /srv/studio/infra-apps/postgres && docker compose logs -f postgres"

[tasks.postgres-shell]
description = "Enter PostgreSQL container"
run = "cd /srv/studio/infra-apps/postgres && docker compose exec postgres psql -U postgres"

[tasks.redis-logs]
description = "View Redis logs"
run = "cd /srv/studio/infra-apps/redis && docker compose logs -f redis"

[tasks.redis-cli]
description = "Enter Redis CLI"
run = "cd /srv/studio/infra-apps/redis && docker compose exec redis redis-cli"

[tasks.caddy-logs]
description = "View Caddy logs"
run = "cd /srv/studio/infra-apps/caddy && docker compose logs -f caddy"

[tasks.caddy-reload]
description = "Reload Caddy configuration"
run = "cd /srv/studio/infra-apps/caddy && docker compose exec caddy caddy reload --config /etc/caddy/Caddyfile"

# ==================== All Services ====================

[tasks.status]
description = "Show status of all services"
run = """
echo "=== Application ===" && cd /srv/studio/infra-apps/app && docker compose ps
echo -e "\n=== PostgreSQL ===" && cd /srv/studio/infra-apps/postgres && docker compose ps
echo -e "\n=== Redis ===" && cd /srv/studio/infra-apps/redis && docker compose ps
echo -e "\n=== Caddy ===" && cd /srv/studio/infra-apps/caddy && docker compose ps
"""

[tasks.restart-all]
description = "Restart all services"
run = """
cd /srv/studio/infra-apps/app && docker compose restart
cd /srv/studio/infra-apps/postgres && docker compose restart
cd /srv/studio/infra-apps/redis && docker compose restart
cd /srv/studio/infra-apps/caddy && docker compose restart
"""

# ==================== System Monitoring ====================

[tasks.disk]
description = "Show disk usage"
run = "df -h"

[tasks.disk-data]
description = "Show /data directory usage"
run = "du -sh /data/* | sort -h"

[tasks.mem]
description = "Show memory usage"
run = "free -h"

[tasks.docker-stats]
description = "Show Docker container resource usage"
run = "docker stats --no-stream"

[tasks.docker-prune]
description = "Clean up unused Docker resources"
run = "docker system prune -f && docker volume prune -f"

# ==================== Logs Management ====================

[tasks.logs-app]
description = "Follow all application logs"
run = "tail -f /data/logs/app/*.log"

[tasks.logs-nginx]
description = "Follow nginx/caddy access logs"
run = "cd /srv/studio/infra-apps/caddy && docker compose logs -f"
