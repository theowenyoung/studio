experimental_monorepo_root = true
[settings]
task.monorepo_depth = 3  # Only search 2 levels deep
[tools]
python = "latest"
zig = "latest"
bun = "latest"
node = "latest"
rust = "latest"
"cargo:psenv" = "latest"
[env]
# AWS ECR registry
ECR_REGISTRY = "912951144733.dkr.ecr.us-west-2.amazonaws.com"

[tasks]
# 初始化
build = 'pnpm --filter "./js-apps/*" build'
clean = 'pnpm --filter "./js-apps/*" clean'
"dev:hono" = 'pnpm --filter "hono-demo" dev'
dev = 'pnpm --filter "./js-apps/*" dev'
format = 'prettier --write "**/*.{ts,tsx,md}"'
lint = 'pnpm --filter "./js-apps/*" lint'
test = 'pnpm --filter "./js-apps/*" test'
"init:network" = 'docker network create shared'
"up:postgres" = 'cd infra-apps/postgres && docker compose up'
"down:postgres" = 'cd infra-apps/postgres && docker compose down'
"up:caddy" = 'cd infra-apps/caddy && docker compose up'
"down:caddy" = 'cd infra-apps/caddy && docker compose down'
"up:redis" = 'cd infra-apps/redis && docker compose up'
"down:redis" = 'cd infra-apps/redis && docker compose down'
"build:psenv" = 'cd rust-packages/psenv && cargo build --release'
"release:psenv" = 'cd rust-packages/psenv && cargo publish'
"env:postgres" = 'cd infra-apps/postgres && psenv -t .env.example -p "/studio-dev/" -o .env'
"env:redis" = 'cd infra-apps/redis && psenv -t .env.example -p "/studio-dev/" -o .env'
"env:hono" = 'cd js-apps/hono-demo && psenv -t .env.example -p "/studio-dev/" -o .env'
"env:backup" = 'cd infra-apps/backup && psenv -t .env.example -p "/studio-dev/" -o .env'
"env:admin" = 'cd infra-apps/db-admin && psenv -t .env.example -p "/studio-dev/" -o .env'
"db:admin:migrations" = "cd infra-apps/db-admin && docker compose run --rm db-admin"
"db" = "cd infra-apps/postgres && docker compose exec postgres psql -U postgres"
"migrate:hono" = 'pnpm --filter "./js-apps/hono-demo" migrate'
"migrate" = 'pnpm --filter "./js-apps/*" migrate'
"install" = 'pnpm --filter "./js-apps/*" install'
serve = 'pnpm --filter "./js-apps/*" start'
# 备份
"dev:backup" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/backup-all.sh'
"build:backup" = 'cd infra-apps/backup && docker compose build'
"backup:list" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/list-backups.sh'

# 恢复 - 本地
"restore:postgres:latest" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/restore-postgres-local.sh latest'
"restore:postgres:file" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/restore-postgres-local.sh'

# 恢复 - S3
"restore:postgres:s3:list" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/list-s3-postgres.sh'
"restore:postgres:s3:latest" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/restore-postgres-s3.sh latest'
"restore:postgres:s3:file" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/restore-postgres-s3.sh'

# 清理
"clean:postgres:soft" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/clean-postgres.sh'
"clean:postgres:hard" = 'cd infra-apps/postgres && docker compose down -v'
"clean:s3:smart" = 'cd infra-apps/backup && docker compose run --rm backup /usr/local/bin/cleanup-s3-smart.sh'

[tasks.addjs]
usage = '''
arg "<project>"
arg "[packages]" var=#true
'''
run = 'pnpm --filter "./js-apps/${usage_project?}" add ${usage_packages?}'


[tasks.init]
depends = ["init:network"]

[tasks.up]
depends = ["up:postgres", "up:caddy", "up:redis"]

[tasks."db:init"]
depends = ["db:admin:migrations"]


[tasks.down]
depends = ["down:postgres", "down:caddy", "down:redis"]

[tasks.env]
depends = ["env:postgres","env:redis","env:hono","env:backup","env:admin"]
