[tools]
python = "latest"
zig = "latest"
bun = "latest"
node = "latest"
rust = "latest"
"cargo:psenv" = "latest"
"zola" = "latest"

[env]
# AWS ECR registry
ECR_REGISTRY = "912951144733.dkr.ecr.us-west-2.amazonaws.com"

# ==================== å¼€å‘ç›¸å…³ (dev-) ====================
# å¼€å‘æœåŠ¡å™¨ + æœ¬åœ° Docker + ç¯å¢ƒå˜é‡

[tasks.dev-hono]
description = "Start hono-demo development server"
run = 'pnpm --filter "hono-demo" dev'

[tasks.dev-proxy]
description = "Start proxy development server"
run = 'pnpm --filter "proxy" dev'

[tasks.dev-api]
description = "Start api development server"
run = 'pnpm --filter "api" dev'

[tasks.dev-meilisearch]
description = "Start meilisearch service"
run = 'docker compose up'
dir = "external-apps/meilisearch"

[tasks.dev-all]
description = "Start all development servers"
alias = "dev"
run = 'pnpm --parallel --filter "./js-apps/*" dev'

[tasks.dev-kill]
description = "Kill all development servers (cleanup after Ctrl+C)"
run = '''
echo "ğŸ”ª Killing all development servers..."
# æ€æ­»å¸¸è§çš„å¼€å‘æœåŠ¡å™¨è¿›ç¨‹
pkill -f "vite" || true
pkill -f "remix dev" || true
pkill -f "next dev" || true
pkill -f "node.*dev" || true
pkill -f "tsx watch" || true
# æ€æ­»å ç”¨å¸¸è§å¼€å‘ç«¯å£çš„è¿›ç¨‹
lsof -ti:3000,3001,5173,8001,8002,8003,9001,9002,9003 | xargs kill -9 2>/dev/null || true
echo "âœ… All development servers killed"
'''

[tasks.dev-init]
description = "Initialize local environment (create Docker network)"
alias = "init"
run = 'docker network create shared'

[tasks.dev-up]
description = "Start all local infrastructure"
alias = "up"
depends = ["dev-up-postgres", "dev-up-redis", "dev-up-caddy", "dev-up-meilisearch"]

[tasks.dev-down]
description = "Stop all local infrastructure"
alias = "down"
depends = ["dev-down-postgres", "dev-down-redis", "dev-down-caddy", "dev-down-meilisearch"]

[tasks.dev-logs]
description = "View logs from all local infrastructure services"
alias = "logs"
run = '''
echo "Starting log tail for postgres, redis, and caddy..."
echo "Press Ctrl+C to stop"
echo ""
docker compose -f infra-apps/postgres/docker-compose.yml -f infra-apps/redis/docker-compose.yml -f infra-apps/caddy/docker-compose.yml logs -f --tail=50
'''

[tasks.dev-logs-postgres]
description = "View PostgreSQL logs"
run = 'docker compose logs -f --tail=100'
dir = "infra-apps/postgres"

[tasks.dev-logs-redis]
description = "View Redis logs"
run = 'docker compose logs -f --tail=100'
dir = "infra-apps/redis"

[tasks.dev-logs-caddy]
description = "View Caddy logs"
run = 'docker compose logs -f --tail=100'
dir = "infra-apps/caddy"

[tasks.dev-up-postgres]
description = "Start local PostgreSQL"
run = 'docker compose up -d'
dir = "infra-apps/postgres"

[tasks.dev-up-redis]
description = "Start local Redis"
run = 'docker compose up -d'
dir = "infra-apps/redis"

[tasks.dev-up-caddy]
description = "Start local Caddy"
run = 'docker compose up -d'
dir = "infra-apps/caddy"

[tasks.dev-down-postgres]
description = "Stop local PostgreSQL"
run = 'docker compose down'
dir = "infra-apps/postgres"

[tasks.dev-down-redis]
description = "Stop local Redis"
run = 'docker compose down'
dir = "infra-apps/redis"

[tasks.dev-down-caddy]
description = "Stop local Caddy"
run = 'docker compose down'
dir = "infra-apps/caddy"

[tasks.dev-up-meilisearch]
description = "Start local Meilisearch"
run = 'docker compose up -d'
dir = "external-apps/meilisearch"

[tasks.dev-down-meilisearch]
description = "Stop local Meilisearch"
run = 'docker compose down'
dir = "external-apps/meilisearch"

[tasks.dev-logs-meilisearch]
description = "View Meilisearch logs"
run = 'docker compose logs -f --tail=100'
dir = "external-apps/meilisearch"

[tasks.dev-env]
description = "Fetch all development environment variables"
alias = "env"
depends = ["dev-env-postgres", "dev-env-redis", "dev-env-hono", "dev-env-backup", "dev-env-admin", "dev-env-meilisearch"]

[tasks.dev-env-postgres]
description = "Fetch PostgreSQL dev environment variables"
run = 'psenv -t .env.example -p "/studio-dev/" -o .env'
dir = "infra-apps/postgres"

[tasks.dev-env-redis]
description = "Fetch Redis dev environment variables"
run = 'psenv -t .env.example -p "/studio-dev/" -o .env'
dir = "infra-apps/redis"

[tasks.dev-env-hono]
description = "Fetch hono-demo dev environment variables"
run = 'psenv -t .env.example -p "/studio-dev/" -o .env'
dir = "js-apps/hono-demo"

[tasks.dev-env-backup]
description = "Fetch backup dev environment variables"
run = 'psenv -t .env.example -p "/studio-dev/" -o .env'
dir = "infra-apps/backup"

[tasks.dev-env-admin]
description = "Fetch db-admin dev environment variables"
run = 'psenv -t .env.example -p "/studio-dev/" -o .env'
dir = "infra-apps/db-admin"

[tasks.dev-env-meilisearch]
description = "Fetch meilisearch dev environment variables"
run = 'psenv -t .env.example -p "/studio-dev/" -o .env'
dir = "external-apps/meilisearch"

[tasks.dev-backup]
description = "Run backup in dev environment"
run = 'docker compose run --rm backup /usr/local/bin/backup-all.sh'
dir = "infra-apps/backup"

# ==================== æ•°æ®åº“æ“ä½œ (db-) ====================

[tasks.db-connect]
description = "Connect to PostgreSQL database"
alias = "db"
run = 'docker compose exec postgres psql -U postgres'
dir = "infra-apps/postgres"

[tasks.db-init]
description = "Initialize database (run admin migrations)"
run = "docker compose run --rm db-admin"
dir = "infra-apps/db-admin"

[tasks.db-init-prod-mode]
description = "Initialize local database with production-like setup"
run = '''
#!/bin/bash
echo "ğŸ”§ Initializing production-like local database..."
echo ""
echo "This will create:"
echo "  - Individual users for each application"
echo "  - Read-only users"
echo "  - Proper permission isolation"
echo ""
read -p "Continue? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "Aborted."
    exit 0
fi

# Run production migrations locally
docker compose run --rm -e DEPLOY_ENV=prod db-admin
echo ""
echo "âœ… Production-like database initialized!"
echo "ğŸ’¡ Update your .env files to use production credentials"
'''
dir = "infra-apps/db-admin"

[tasks.db-migrate]
description = "Run all application migrations"
run = 'pnpm --filter "./js-apps/*" migrate'

[tasks.db-migrate-hono]
description = "Run hono-demo migrations"
run = 'pnpm --filter "./js-apps/hono-demo" migrate'

# ==================== æ„å»º (build-) ====================

# åŸºç¡€è®¾æ–½æ„å»º
[tasks.build-infra-postgres]
description = "Build PostgreSQL infrastructure"
run = "bash infra-apps/postgres/build.sh"

[tasks.build-infra-redis]
description = "Build Redis infrastructure"
run = "bash infra-apps/redis/build.sh"

[tasks.build-infra-caddy]
description = "Build Caddy infrastructure"
run = "bash infra-apps/caddy/build.sh"

[tasks.build-infra-backup]
description = "Build backup infrastructure"
run = "bash infra-apps/backup/build.sh"

# JS åº”ç”¨æ„å»º
[tasks.build-hono-demo]
description = "Build hono-demo application"
run = "bash js-apps/hono-demo/build.sh"

[tasks.build-proxy]
description = "Build proxy application"
run = "bash js-apps/proxy/build.sh"

[tasks.build-blog]
description = "Build blog application"
run = "bash js-apps/blog/build.sh"

[tasks.build-storefront]
description = "Build storefront application"
run = "bash js-apps/storefront/build.sh"

# External åº”ç”¨æ„å»º
[tasks.build-meilisearch]
description = "Build meilisearch"
run = "bash external-apps/meilisearch/build.sh"

[tasks.build-owen-blog]
description = "Build owen-blog"
run = "bash external-apps/owen-blog/build.sh"

# ==================== éƒ¨ç½² (deploy-) ====================

# åŸºç¡€è®¾æ–½éƒ¨ç½²
[tasks.deploy-infra]
description = "Deploy all infrastructure services"
run = ["mise run deploy-infra-postgres", "mise run deploy-infra-redis", "mise run deploy-infra-caddy", "mise run deploy-infra-backup", "mise run deploy-infra-db-admin"]

[tasks.deploy-infra-postgres]
description = "Deploy PostgreSQL to prod"
depends = ["build-infra-postgres"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-postgres.yml"
alias = "deploy-postgres"

[tasks.deploy-infra-redis]
description = "Deploy Redis to prod"
depends = ["build-infra-redis"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-redis.yml"
alias = "deploy-redis"

[tasks.deploy-infra-caddy]
description = "Deploy Caddy to prod"
depends = ["build-infra-caddy"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-caddy.yml"
alias = "deploy-caddy"

[tasks.deploy-infra-caddy-reload]
description = "Quick reload Caddy config (no build, only sync & reload)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-caddy-reload.yml"
alias = "reload-caddy"

[tasks.deploy-infra-backup]
description = "Deploy backup service to prod"
depends = ["build-infra-backup"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-infra-backup.yml"

# JS åº”ç”¨éƒ¨ç½²ï¼ˆæ™ºèƒ½æ£€æµ‹ç¯å¢ƒï¼šmain=production, å…¶ä»–=previewï¼‰
[tasks.deploy-apps]
description = "Deploy all applications"
run = ["mise run deploy-hono-demo", "mise run deploy-proxy", "mise run deploy-blog", "mise run deploy-storefront", "mise run deploy-meilisearch", "mise run deploy-owen-blog"]

[tasks.deploy-hono-demo]
description = "Deploy hono-demo (auto-detect environment)"
depends = ["build-hono-demo"]
run = "bash scripts/deploy-app.sh hono-demo"
alias = "deploy-hono"

[tasks.deploy-proxy]
description = "Deploy proxy (auto-detect environment)"
depends = ["build-proxy"]
run = "bash scripts/deploy-app.sh proxy"

[tasks.deploy-blog]
description = "Deploy blog (auto-detect environment)"
depends = ["build-blog"]
run = "bash scripts/deploy-app.sh blog"

[tasks.deploy-storefront]
description = "Deploy storefront (auto-detect environment)"
depends = ["build-storefront"]
run = "bash scripts/deploy-app.sh storefront"

# External åº”ç”¨éƒ¨ç½²
[tasks.deploy-meilisearch]
description = "Deploy meilisearch to prod"
depends = ["build-meilisearch"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-external-app.yml -e service_name=meilisearch"

[tasks.deploy-owen-blog]
description = "Deploy owen-blog to prod"
depends = ["build-owen-blog"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-external-app.yml -e service_name=owen-blog"

# æ•°æ®åº“è¿ç§»éƒ¨ç½²
[tasks.deploy-infra-db-admin]
description = "Run database migrations in prod"
depends = ["build-db-admin"]
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/deploy-db-admin.yml"
alias = "deploy-db-admin"

[tasks.deploy-migrate-hono]
description = "Run hono-demo migrations in prod"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/migrate-app.yml -e service_name=hono-demo"


# ==================== æœåŠ¡å™¨ç®¡ç† (server-) ====================

# å¿«æ· SSH è¿æ¥

[tasks.ssh]
description = "SSH to prod server and cd to /srv/studio"
run = 'ssh -t deploy@5.78.126.18 "cd /srv/studio && exec bash -l"'
alias = "ssh-prod"

[tasks.ssh-preview]
description = "SSH to preview server and cd to /srv/studio"
run = 'ssh -t deploy@49.13.31.185 "cd /srv/studio && exec bash -l"'

# ç”¨è„šæœ¬åˆ›å»ºåˆå§‹ç”¨æˆ·
[tasks.server-init-user]
description = "Create deploy user on server(s)"
usage = '''
arg "<ip>" var=#true
flag "-u --user <user>" help="admin user" default="root" env="ADMIN_USER"
'''
run = '''
for ip in ${usage_ip?}; do
  rsync -chazP ./scripts/create-init-user.sh ${usage_user?}@$ip:
  ssh ${usage_user?}@$ip 'bash create-init-user.sh'
done
'''

# æœåŠ¡å™¨åˆå§‹åŒ–
[tasks.server-init-prod]
description = "Initialize prod server (security, docker, directories, mise, aliases)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/init-server.yml -e force_system_update=true -l prod"

[tasks.server-init-preview]
description = "Initialize preview server (security, docker, directories, mise, aliases)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/init-server.yml -e force_system_update=true -l preview"

[tasks.server-init-all]
description = "Initialize all servers (use with caution)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/init-server.yml -e force_system_update=true -l all"
alias = "server-init"

# æœåŠ¡å™¨æ™®é€šæ›´æ–°
[tasks.server-update-prod]
description = "Update prod server configuration (skip system update)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/init-server.yml -l prod"

[tasks.server-update-preview]
description = "Update preview server configuration (skip system update)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/init-server.yml -l preview"

[tasks.server-update-all]
description = "Update all servers configuration (skip system update)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/init-server.yml -l all"
alias = "server-update"


# åŒæ­¥æœåŠ¡å™¨é…ç½®
[tasks.server-sync-config-prod]
description = "Sync server-mise.toml and bash_aliases to prod server"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/sync-server-config.yml -l prod"

[tasks.server-sync-config-preview]
description = "Sync server-mise.toml and bash_aliases to preview server"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/sync-server-config.yml -l preview"

[tasks.server-sync-config-all]
description = "Sync server-mise.toml and bash_aliases to all servers"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/sync-server-config.yml -l all"
alias = "sync-config"

[tasks.server-configure-aws-prod]
description = "Configure AWS credentials on prod server (for ECR access)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/configure-aws-credentials.yml -l prod"

[tasks.server-configure-aws-preview]
description = "Configure AWS credentials on preview server (for ECR access)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/configure-aws-credentials.yml -l preview"

[tasks.server-configure-aws-all]
description = "Configure AWS credentials on all servers (for ECR access)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/configure-aws-credentials.yml -l all"
alias = "server-configure-aws"

# å¤‡ä»½ä¸æ¢å¤ï¼ˆé€šè¿‡ Ansible è§¦å‘ï¼‰
[tasks.server-backup]
description = "Run backup on prod server"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/run-backup.yml"
alias = "backup"

# Volume ç®¡ç†
[tasks.server-resize-volume-prod]
description = "Resize Hetzner volume on prod server (expand filesystem)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/resize.yml -l prod"

[tasks.server-resize-volume-preview]
description = "Resize Hetzner volume on preview server (expand filesystem)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/resize.yml -l preview"

[tasks.server-resize-volume-all]
description = "Resize Hetzner volume on all servers (expand filesystem)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/resize.yml -l all"
alias = "resize"

# Docker æ•°æ®æ¸…ç†ï¼ˆç³»ç»Ÿé‡å»ºå‰å¤‡ä»½ï¼‰
[tasks.server-clean-docker-prod]
description = "Clean Docker data on prod server (move to .old backup before rebuild)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/clean-docker.yml -l prod"

[tasks.server-clean-docker-preview]
description = "Clean Docker data on preview server (move to .old backup before rebuild)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/clean-docker.yml -l preview"

[tasks.server-clean-docker-all]
description = "Clean Docker data on all servers (move to .old backup before rebuild)"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/clean-docker.yml -l all"
alias = "clean-docker"

# Note: å…¶ä»–æœåŠ¡å™¨è¿ç»´ä»»åŠ¡ï¼ˆæŸ¥çœ‹æ—¥å¿—ã€æ¢å¤æ•°æ®åº“ã€æŸ¥çœ‹å¤‡ä»½ç­‰ï¼‰
# è¯· SSH åˆ°æœåŠ¡å™¨åä½¿ç”¨ server-mise.toml ä¸­å®šä¹‰çš„ä»»åŠ¡
# ä¾‹å¦‚ï¼šmise ssh-studio ç„¶å mise run db-restore-local

# ==================== é€šç”¨å·¥å…· (æ— å‰ç¼€) ====================

[tasks.lint]
description = "Lint all projects"
run = 'pnpm --filter "./js-apps/*" lint'

[tasks.format]
description = "Format code with Prettier"
run = 'prettier --write "**/*.{ts,tsx,md}"'

[tasks.test]
description = "Run tests"
run = 'pnpm --filter "./js-apps/*" test'

[tasks.clean]
description = "Clean build artifacts"
run = 'pnpm --filter "./js-apps/*" clean'

[tasks.install]
description = "Install dependencies"
run = 'pnpm --filter "./js-apps/*" install'

[tasks.build]
description = "Build all projects"
run = 'pnpm --filter "./js-apps/*" build'

[tasks.serve]
description = "Serve built applications"
run = 'pnpm --filter "./js-apps/*" start'

# ==================== è¾…åŠ©å·¥å…· ====================

[tasks.build-db-admin]
description = "Build db-admin (prepare migrations)"
run = "bash infra-apps/db-admin/build.sh"

[tasks.build-psenv]
description = "Build psenv Rust tool"
run = 'cargo build --release'
dir = "rust-packages/psenv"

[tasks.release-psenv]
description = "Publish psenv to crates.io"
run = 'cargo publish'
dir = "rust-packages/psenv"

# ==================== AWS ECR ç®¡ç† ====================

[tasks.ecr-setup-lifecycle]
description = "Setup lifecycle policies for all ECR repositories"
run = "bash scripts/setup-ecr-lifecycle.sh"
alias = "ecr-lifecycle"

# ==================== åŠ¨æ€ä»»åŠ¡ ====================

[tasks.addjs]
description = "Add package to a specific JS project"
usage = '''
arg "<project>"
arg "[packages]" var=#true
'''
run = 'pnpm --filter "./js-apps/${usage_project?}" add ${usage_packages?}'

[tasks.buildjs]
description = "Run custom build command for a JS project"
usage = '''
arg "<project>"
arg "[args]" var=#true
'''
run = 'pnpm --filter "./js-apps/${usage_project?}" ${usage_args?}'

# ==================== é¢„è§ˆç¯å¢ƒç®¡ç† ====================

[tasks.preview-info]
description = "Show current branch's preview environment info"
alias = "info"
run = "bash scripts/preview-info.sh"

[tasks.preview-destroy]
description = "Destroy current branch's preview environment"
run = "bash scripts/preview-destroy.sh"

[tasks.preview-list]
description = "List all active preview environments on preview server"
run = "ansible-playbook -i ansible/inventory.yml ansible/playbooks/list-previews.yml -l preview"

[tasks.preview-list-old]
description = "List all old preview databases (default: >7 days)"
run = "bash scripts/preview-list-old.sh"
usage = '''
arg "[days]" help="Age threshold in days (default: 7)"
'''
