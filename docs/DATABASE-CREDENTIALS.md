# 数据库凭证管理策略

## 设计原则

**生产环境**：固定的数据库和用户，凭证存储在 AWS Parameter Store
**预览环境**：共享用户 + 动态数据库，最小化凭证管理复杂度

---

## AWS Parameter Store 配置

### 生产环境 (studio-prod)

```bash
# PostgreSQL 连接信息
/studio-prod/database/host: 5.78.126.18
/studio-prod/database/port: 5432

# PostgreSQL 超级用户
/studio-prod/database/postgres_password: <strong-password>

# Demo 应用数据库
/studio-prod/database/demo_user_password: <password>
/studio-prod/database/demo_readonly_password: <password>

# Hono Demo 应用数据库
/studio-prod/database/hono_user_password: <password>
/studio-prod/database/hono_readonly_password: <password>

# Blog 应用数据库
/studio-prod/database/blog_user_password: <password>
/studio-prod/database/blog_readonly_password: <password>
```

### 预览环境 (studio-preview)

```bash
# PostgreSQL 连接信息
/studio-preview/database/host: 49.13.31.185
/studio-preview/database/port: 5432

# PostgreSQL 超级用户（用于创建数据库）
/studio-preview/database/postgres_password: <strong-password>

# 共享应用用户（所有预览应用使用）
/studio-preview/database/app_user_password: <password>
```

**注意**：预览环境只需要 3 个凭证！

---

## 数据库架构

### 生产环境

```sql
-- 每个应用独立的用户和数据库
CREATE USER demo_user WITH PASSWORD 'xxx';
CREATE USER demo_readonly WITH PASSWORD 'xxx';
CREATE DATABASE demo OWNER demo_user;
GRANT CONNECT ON DATABASE demo TO demo_readonly;

CREATE USER hono_user WITH PASSWORD 'xxx';
CREATE USER hono_readonly WITH PASSWORD 'xxx';
CREATE DATABASE hono_demo OWNER hono_user;
GRANT CONNECT ON DATABASE hono_demo TO hono_readonly;

CREATE USER blog_user WITH PASSWORD 'xxx';
CREATE DATABASE blog OWNER blog_user;
```

### 预览环境

```sql
-- 初始化：创建共享用户（只执行一次）
CREATE USER preview_app_user WITH PASSWORD 'xxx' CREATEDB;
GRANT preview_app_user TO postgres;

CREATE DATABASE template_preview
    WITH OWNER = preview_app_user
    TEMPLATE = template0
    ENCODING = 'UTF8';
UPDATE pg_database SET datistemplate = TRUE WHERE datname = 'template_preview';

-- 部署时：动态创建数据库
CREATE DATABASE feature_x_hono_demo OWNER preview_app_user TEMPLATE template_preview;
CREATE DATABASE feature_y_blog OWNER preview_app_user TEMPLATE template_preview;
CREATE DATABASE hotfix_123_demo OWNER preview_app_user TEMPLATE template_preview;
```

---

## 环境变量配置

### 生产应用 (.env.example)

```bash
# js-apps/hono-demo/.env.example
DATABASE_HOST=<from-psenv:/studio-prod/database/host>
DATABASE_PORT=<from-psenv:/studio-prod/database/port>
DATABASE_NAME=hono_demo
DATABASE_USER=hono_user
DATABASE_PASSWORD=<from-psenv:/studio-prod/database/hono_user_password>
DATABASE_READONLY_USER=hono_readonly
DATABASE_READONLY_PASSWORD=<from-psenv:/studio-prod/database/hono_readonly_password>
```

### 预览应用 (.env.example)

```bash
# js-apps/hono-demo/.env.example (preview)
DATABASE_HOST=<from-psenv:/studio-preview/database/host>
DATABASE_PORT=<from-psenv:/studio-preview/database/port>
DATABASE_NAME=<auto-generated>  # 由部署脚本生成：{branch}_hono_demo
DATABASE_USER=preview_app_user
DATABASE_PASSWORD=<from-psenv:/studio-preview/database/app_user_password>
```

---

## 部署流程

### 生产环境部署

```bash
# 1. 初始化数据库基础设施（只执行一次）
DEPLOY_ENV=prod mise run deploy-db-admin

# 执行 migrations/prod/*.sh：
# - 001-create-demo-db.sh
# - 002-create-hono-db.sh
# - ...

# 2. 部署应用
mise run deploy-hono
```

### 预览环境部署

```bash
# 1. 初始化预览环境基础设施（只执行一次）
DEPLOY_ENV=preview mise run deploy-db-admin

# 执行 migrations/preview/001-init-preview.sh：
# - 创建 preview_app_user
# - 创建 template_preview

# 2. 部署应用（自动创建数据库）
git checkout feature-new-ui
mise run deploy-hono

# deploy-app.yml 会自动：
# - 检测分支名：feature-new-ui
# - 生成数据库名：feature_new_ui_hono_demo
# - 创建数据库（如果不存在）
# - 运行应用迁移
# - 部署容器
```

---

## 清理流程

### 预览环境清理

```bash
# scripts/preview-destroy.sh 会删除：
mise run preview-destroy

# 1. 停止并删除容器
docker compose down

# 2. 删除数据库
docker exec postgres psql -U postgres -c "DROP DATABASE IF EXISTS feature_x_hono_demo"
docker exec postgres psql -U postgres -c "DROP DATABASE IF EXISTS feature_x_blog"

# 3. 删除 Caddy 配置
rm /srv/studio/infra-apps/caddy/src/config/preview/feature-x-*.caddy

# 4. 删除 Docker 镜像
docker rmi feature-x-hono-demo:preview-feature-x
```

---

## 安全考虑

### 为什么预览环境可以共享用户？

1. **预览环境是临时的** - 不存储敏感数据
2. **数据库层面隔离** - 每个分支独立数据库
3. **网络层隔离** - 预览服务器独立
4. **访问控制** - 只有团队成员可访问

### 如果需要更强的隔离？

可以为每个分支创建独立用户：

```sql
-- 部署时
CREATE USER feature_x_hono_user WITH PASSWORD 'random_password';
CREATE DATABASE feature_x_hono_demo OWNER feature_x_hono_user;
```

**但这会带来复杂性**：
- 需要动态生成和存储密码
- 清理时需要删除用户
- 可能达到用户数上限

**建议**：除非有明确的安全需求，否则使用共享用户方案。

---

## 初始化命令

### 设置 AWS Parameter Store

```bash
# 生产环境
aws ssm put-parameter --name /studio-prod/database/host --value "5.78.126.18" --type String
aws ssm put-parameter --name /studio-prod/database/postgres_password --value "<password>" --type SecureString
aws ssm put-parameter --name /studio-prod/database/demo_user_password --value "<password>" --type SecureString
aws ssm put-parameter --name /studio-prod/database/hono_user_password --value "<password>" --type SecureString

# 预览环境（只需要3个）
aws ssm put-parameter --name /studio-preview/database/host --value "49.13.31.185" --type String
aws ssm put-parameter --name /studio-preview/database/postgres_password --value "<password>" --type SecureString
aws ssm put-parameter --name /studio-preview/database/app_user_password --value "<password>" --type SecureString
```

### 初始化数据库

```bash
# 生产环境
ansible-playbook -i ansible/inventory.yml \
  ansible/playbooks/deploy-db-admin.yml \
  -e DEPLOY_ENV=prod

# 预览环境
ansible-playbook -i ansible/inventory.yml \
  ansible/playbooks/deploy-db-admin.yml \
  -e DEPLOY_ENV=preview \
  -l preview
```

---

## 迁移文件管理

### 目录结构

```
infra-apps/db-admin/
├── migrations/
│   ├── prod/                           # 生产环境迁移
│   │   ├── 001-create-demo-db.sh       # 创建 demo 数据库
│   │   ├── 002-create-hono-db.sh       # 创建 hono_demo 数据库
│   │   └── 003-create-blog-db.sh       # 创建 blog 数据库
│   └── preview/                        # 预览环境迁移
│       └── 001-init-preview.sh         # 创建共享用户和模板
└── scripts/
    ├── common.sh                       # 共享函数
    ├── run-migrations.sh               # 迁移运行器（根据 DEPLOY_ENV 选择目录）
    └── create-preview-db.sh            # 动态创建预览数据库
```

### 添加新的生产数据库

```bash
# 1. 创建迁移文件
cat > infra-apps/db-admin/migrations/prod/004-create-storefront-db.sh <<'EOF'
#!/bin/sh
set -e
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
. "$SCRIPT_DIR/../../scripts/common.sh"

DB_NAME="storefront"
RW_PASSWORD="${POSTGRES_STOREFRONT_USER_PASSWORD:?Error: not set}"
RO_PASSWORD="${POSTGRES_STOREFRONT_READONLY_PASSWORD:?Error: not set}"

create_database_with_users "$DB_NAME" "$RW_PASSWORD" "$RO_PASSWORD" "Storefront application"
EOF

chmod +x infra-apps/db-admin/migrations/prod/004-create-storefront-db.sh

# 2. 添加 AWS Parameter Store 凭证
aws ssm put-parameter --name /studio-prod/database/storefront_user_password --value "<password>" --type SecureString
aws ssm put-parameter --name /studio-prod/database/storefront_readonly_password --value "<password>" --type SecureString

# 3. 运行迁移
mise run deploy-db-admin
```

---

## 常见问题

### Q: 预览环境的数据库会相互影响吗？

A: 不会。每个分支有独立的数据库，数据完全隔离。

### Q: 预览环境的数据库会被其他人访问吗？

A: 不会。只有拥有 `preview_app_user` 密码的人才能访问，且该密码只存储在 AWS Parameter Store 中。

### Q: 如果预览服务器上的数据库太多怎么办？

A: `preview-destroy` 会自动删除数据库。你也可以定期清理：

```bash
# 列出所有预览数据库
docker exec postgres psql -U postgres -c "\l" | grep "_demo\|_blog"

# 删除 7 天前的旧数据库（手动或自动化）
```

### Q: 生产环境可以用这个模式吗？

A: 不推荐。生产环境应该：
- 每个应用独立的用户（更好的审计和权限控制）
- 明确的权限管理（只读用户、备份用户等）
- 长期稳定的凭证（存储在 Parameter Store）

### Q: 为什么不用 Docker Compose 的环境变量？

A: Docker Compose 环境变量适合静态配置。动态数据库名需要在部署时计算，通过 Ansible 传递更灵活。
