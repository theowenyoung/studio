services:
  backup:
    build: .
    restart: unless-stopped
    env_file:
      - .env  # 从 .env 加载敏感信息：POSTGRES_ADMIN_URL, REDIS_DOCKER_URL, S3 凭证等
    environment:
      # 非敏感配置，直接在这里设置
      S3_REGION: us-east-005
      ENVIRONMENT: dev
      BACKUP_RETENTION_LOCAL: 3
      BACKUP_RETENTION_S3: 30

      # Cron 调度
      POSTGRES_SCHEDULE: "0 2 * * *"    # 每天凌晨2点
      REDIS_SCHEDULE: "0 3 * * *"       # 每天凌晨3点
      CLEANUP_SCHEDULE: "0 5 * * *"     # 每天凌晨5点
      FULL_BACKUP_SCHEDULE: "0 4 * * 0" # 每周日凌晨4点

      TZ: UTC

    volumes:
      - ./.local/backups:/backups:delegated

    networks:
      - shared

    healthcheck:
      test: ["CMD-SHELL", "test -f /var/log/backup.log || exit 1"]
      interval: 1h
      timeout: 30s
      retries: 3
      start_period: 1m

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  shared:
    external: true
