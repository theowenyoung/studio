{
    # 全局配置
    email owen@owenyoung.com

    # DEBUG: 详细日志用于性能调试
    # TODO: 调试完成后改回 INFO 级别和简单格式
    log {
        level INFO
        output stdout
        format json {
            time_format "iso8601"
        }
    }

    # 性能优化
    servers {
        # 协议优化（启用 HTTP/3）
        protocols h1 h2 h3

        # 连接超时
        timeouts {
            read_body   30s
            read_header 30s
            write       30s
            idle        5m
        }

        # 最大请求头大小（10MB）
        max_header_size 10MB
    }
}

# ==================== Snippets ====================

# ==================== Resilient Proxy ====================
# 单服务器部署的弹性配置 - 在服务重启期间保持请求等待
(resilient_proxy) {
    # try_duration: 在上游不可用时保持请求等待的时间
    # 这样服务重启时不会立即返回 502，而是等待服务恢复
    reverse_proxy {args[0]} {
        # 等待最多 15 秒让服务恢复（足够覆盖大多数重启场景）
        try_duration 15s

        # 健康检查失败后的重试间隔
        fail_duration 5s

        # 单个请求的超时（总时间包含等待）
        # 设置为 try_duration + 正常请求时间
        # timeout 60s
    }
}
# ==================== END Resilient Proxy ====================

# ==================== Observability ====================
# 生产环境的可观测性配置 - 保留用于持续监控
(observability) {
    # 访问日志（JSON 格式，便于日志系统解析）
    log {
        output stdout
        format json {
            time_format "iso8601"
        }
    }
}
# ==================== END Observability ====================

(common_cache) {
    # 启用压缩（统一在 Caddy 层处理）
    encode gzip zstd

    # 静态资源长缓存（1年）
    # 注意：不包含 JSON/XML，因为它们可能是 API 响应
    @static path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp *.avif
    header @static Cache-Control "public, max-age=31536000, immutable"

    # XML 短缓存（1分钟）- sitemap.xml, feed.xml 等
    @xml path *.xml
    header @xml Cache-Control "public, max-age=60"
}

(ssg_cache) {
    import common_cache


    # HTML 不缓存（但允许 revalidate）
    @html path *.html / /*/
    header @html Cache-Control "public, max-age=0, must-revalidate"
}

(app_cache) {
    # 启用压缩（统一在 Caddy 层处理）
    encode gzip zstd

    # 默认：所有请求都不缓存（动态应用优先保证新鲜度）
    header Cache-Control "public, max-age=0, must-revalidate"

    # 静态资源长缓存（1年）- 会覆盖上面的默认规则
    # 不包含 JSON/XML - 它们通常是 API 响应
    @static path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp *.avif
    header @static Cache-Control "public, max-age=31536000, immutable"
}

# ==================== SSG Sites (nginx containers) ====================

owen-blog-demo.owenyoung.com {
    # TLS 优化 - 启用 TLS 1.3 和 session resumption
    tls {
        protocols tls1.2 tls1.3
    }

    import ssg_cache
    import observability
    import resilient_proxy owen-blog:3000
}

remove-cf-for-aigateway.owenyoung.com {
  reverse_proxy https://gateway.ai.cloudflare.com  {
    header_up -cf-*
    header_up Host gateway.ai.cloudflare.com
  }
}
# Blog
blog-demo.owenyoung.com {
    tls {
        protocols tls1.2 tls1.3
    }
    import ssg_cache
    import observability
    import resilient_proxy blog:3000
}

# Storefront
storefront-demo.owenyoung.com {
    tls {
        protocols tls1.2 tls1.3
    }
    import ssg_cache
    import observability
    import resilient_proxy storefront:3000
}

# ==================== Application Services ====================
# API
api-demo.owenyoung.com {
    import app_cache
    import resilient_proxy api:3000
}

# Hono Demo
hono-demo.owenyoung.com {
    import app_cache
    import resilient_proxy hono-demo:3000
}

# Proxy
proxy-demo.owenyoung.com {
    import app_cache
    import resilient_proxy proxy:3000
}
