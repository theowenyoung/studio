# =====================================
# 数据库一次性任务执行器
# 用于执行数据库管理任务
# =====================================

services:
  db-task-runner:
    image: postgres:17-alpine
    working_dir: /tasks
    env_file:
      - .env  # 从 .env 文件读取环境变量
    volumes:
      # 任务脚本（只读）
      - /srv/database-tasks/tasks:/tasks:ro
      
      # 执行日志（写入 /data 持久化）
      - /data/database-tasks/logs:/logs
    networks:
      - shared_network
    environment:
      # 连接到 PostgreSQL 主服务
      - PGHOST=postgres  # Docker Compose 服务名
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=${POSTGRES_ADMIN_PASSWORD}
      
      # 设置日志输出
      - PGLOGFILE=/logs/task-execution.log
    profiles:
      - task  # 只在需要时启动
    command: tail -f /dev/null  # 保持容器运行

# 使用与 PostgreSQL 相同的网络
networks:
  shared_network:
    external: true

