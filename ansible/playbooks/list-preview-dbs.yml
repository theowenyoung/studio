---
- name: List Preview Databases
  hosts: prod_servers
  gather_facts: yes

  vars:
    age_threshold_days: "{{ age_days | default(7) }}"
    branch_filter: "{{ branch_name | default('') }}"

  tasks:
    - name: Query all preview databases
      shell: |
        docker exec postgres psql -U postgres -t -A -F'|' -c "
        SELECT
          d.datname,
          pg_catalog.shobj_description(d.oid, 'pg_database') as comment,
          pg_size_pretty(pg_database_size(d.datname)) as size,
          EXTRACT(DAY FROM (NOW() - (
            CASE
              WHEN pg_catalog.shobj_description(d.oid, 'pg_database') LIKE '%Created:%'
              THEN substring(pg_catalog.shobj_description(d.oid, 'pg_database') from 'Created: ([^|]+)')::timestamp
              ELSE NULL
            END
          ))) as age_days
        FROM pg_database d
        WHERE d.datname LIKE '%\\_%\\_%'
          AND d.datname NOT LIKE 'template%'
          AND d.datname NOT LIKE 'postgres%'
        ORDER BY age_days DESC NULLS LAST, d.datname;
        "
      register: db_list
      changed_when: false

    - name: Parse database information
      set_fact:
        databases: "{{ databases | default([]) + [item | split('|')] }}"
      loop: "{{ db_list.stdout_lines }}"
      when: item != ''

    - name: Display all preview databases
      debug:
        msg: |

          ðŸ“Š Preview Databases on {{ inventory_hostname }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          {{ "%-40s %-10s %-10s %s" | format("Database", "Age", "Size", "Details") }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          {% for db in databases | default([]) %}
          {{ "%-40s %-10s %-10s %s" | format(
            db[0],
            (db[3] + " days") if db[3] != "" else "unknown",
            db[2],
            ("âš ï¸  OLD" if db[3] != "" and db[3]|int > age_threshold_days|int else "")
          ) }}
          {% endfor %}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          Total: {{ databases | default([]) | length }} preview databases
          Old (>{{ age_threshold_days }} days): {{ databases | default([]) | selectattr('3', 'defined') | select('match', '^[0-9]+$') | map('int') | select('>', age_threshold_days|int) | list | length }}

    - name: Display warning for old databases
      debug:
        msg: |
          âš ï¸  Found {{ old_count }} database(s) older than {{ age_threshold_days }} days
          Consider running: mise run preview-destroy
      vars:
        old_count: "{{ databases | default([]) | selectattr('3', 'defined') | select('match', '^[0-9]+$') | map('int') | select('>', age_threshold_days|int) | list | length }}"
      when: databases is defined and old_count|int > 0
