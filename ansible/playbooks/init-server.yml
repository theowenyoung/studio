---
# æœåŠ¡å™¨åˆå§‹åŒ–ä¸»æµç¨‹
# ä½¿ç”¨æ–¹å¼: ansible-playbook -i inventory.yml playbooks/init-server.yml

# 1. åŸºç¡€ç³»ç»Ÿé…ç½®
- name: Bootstrap system
  hosts: all
  become: yes
  gather_facts: yes

  roles:
    - role: robertdebock.bootstrap
      tags: [bootstrap]

    - role: robertdebock.update
      tags: [update]

  post_tasks:
    # å®‰è£…å¸¸ç”¨å·¥å…·åŒ…
    - name: Install common packages
      apt:
        name: "{{ common_packages }}"
        state: present
        update_cache: yes
        cache_valid_time: 3600  # å¦‚æœ apt ç¼“å­˜åœ¨ 1 å°æ—¶å†…æœ‰æ•ˆï¼Œè·³è¿‡ updateï¼ˆèŠ‚çœæ—¶é—´ï¼‰
      when: common_packages is defined and common_packages | length > 0
      tags: [packages, common]

# 2. æŒ‚è½½æ•°æ®ç›˜
- import_playbook: mount.yml
  tags: [mount]

# 3. å®‰å…¨åŠ å›ºï¼ˆåœ¨ Docker ä¹‹å‰é…ç½® UFWï¼‰
- import_playbook: security.yml
  tags: [security]

# 4. å®‰è£… Dockerï¼ˆåœ¨ UFW ä¹‹åå®‰è£…ï¼ŒDocker ä¼šåœ¨å·²æœ‰é˜²ç«å¢™åŸºç¡€ä¸Šé…ç½®ï¼‰
- name: Install Docker
  hosts: all
  become: yes
  gather_facts: yes

  roles:
    - role: geerlingguy.docker
      tags: [docker]

  post_tasks:
    - name: Add deploy user to docker group
      user:
        name: "{{ deploy_user | default('deploy') }}"
        groups: docker
        append: yes
      tags: [docker]

# 5. é…ç½® Dockerï¼ˆæ•°æ®ç›®å½•ã€ç½‘ç»œç­‰ï¼‰
- import_playbook: setup-docker.yml
  tags: [docker-setup]

# 6. éªŒè¯æ‰€æœ‰æœåŠ¡
- name: Verify all services
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Verify services are running
      include_tasks: ../tasks/verify-services.yml
      tags: [verify, always]

# 7. æ˜¾ç¤ºå®Œæˆä¿¡æ¯
- name: Show completion message
  hosts: all
  gather_facts: no

  tasks:
    - name: Display success message
      debug:
        msg:
          - "ğŸ‰ æœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆï¼"
          - ""
          - "å·²å®Œæˆçš„é…ç½®:"
          - "  âœ… ç³»ç»Ÿæ›´æ–°å’ŒåŸºç¡€é…ç½®"
          - "  âœ… å¸¸ç”¨å·¥å…·åŒ…å®‰è£…"
          - "  âœ… æ•°æ®ç›˜æŒ‚è½½ (/data)"
          - "  âœ… å®‰å…¨åŠ å›º (SSH, é˜²ç«å¢™, Fail2ban)"
          - "  âœ… Docker å®‰è£…å’Œé…ç½®"
          - "  âœ… å…±äº«ç½‘ç»œåˆ›å»º"
          - "  âœ… docker-rollout å·¥å…·"
          - ""
          - "æ³¨æ„ï¼š"
          - "  - æ‰€æœ‰æœåŠ¡ç›®å½•ä¼šåœ¨é¦–æ¬¡éƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»º"
          - "  - Docker åœ¨ UFW ä¹‹åå®‰è£…ï¼Œå¯æ­£ç¡®å¤„ç† iptables"
          - ""
          - "ä¸‹ä¸€æ­¥ï¼š"
          - "  mise run deploy-postgres"
          - "  mise run deploy-redis"
          - "  mise run deploy-caddy"
      tags: [always]
