---
- name: Setup Data Storage Mount
  hosts: all
  become: yes
  vars:
    data_mount_point: "/data"

  tasks:
    - name: Check if /data is already mounted
      command: mountpoint -q "{{ data_mount_point }}"
      register: already_mounted
      failed_when: false
      changed_when: false

    - name: Show mount status
      debug:
        msg: "{{ data_mount_point }} is already mounted, skipping setup"
      when: already_mounted.rc == 0

    - name: Setup mount
      when: already_mounted.rc != 0
      block:
        - name: Get all block devices
          command: lsblk -J -b -o NAME,SIZE,TYPE,MOUNTPOINT,FSTYPE
          register: lsblk_output
          changed_when: false

        - name: Parse devices
          set_fact:
            all_devices: "{{ (lsblk_output.stdout | from_json).blockdevices }}"

        - name: Find data disk candidates
          set_fact:
            data_disk_candidates: >-
              {{
                all_devices |
                selectattr('type', 'equalto', 'disk') |
                rejectattr('name', 'match', '^(sr|loop).*') |
                rejectattr('size', 'equalto', 0) |
                list
              }}

        - name: Debug - Show candidates
          debug:
            msg: "{{ item.name }}: {{ (item.size | int / 1073741824) | round(1) }}GB, mounted at {{ item.mountpoint | default('(not mounted)') }}, fstype={{ item.fstype | default('none') }}"
          loop: "{{ data_disk_candidates }}"

        - name: Find largest non-root disk
          set_fact:
            selected_disk: >-
              {{
                data_disk_candidates |
                rejectattr('mountpoint', 'equalto', '/') |
                rejectattr('children', 'undefined') |
                reject('search', 'children.*mountpoint.*/', 'list') |
                sort(attribute='size', reverse=true) |
                first |
                default(none)
              }}

        - name: If no disk without partitions, find largest non-root disk (may have mountpoint)
          set_fact:
            selected_disk: >-
              {{
                data_disk_candidates |
                rejectattr('mountpoint', 'equalto', '/') |
                reject('match', '.*sda.*') |
                sort(attribute='size', reverse=true) |
                first |
                default(none)
              }}
          when: selected_disk is none or selected_disk == ''

        - name: Fail if no suitable disk found
          fail:
            msg: |
              No suitable data disk found.
              Available disks: {{ data_disk_candidates | map(attribute='name') | list }}

              Please manually specify the disk in inventory.yml:
                production:
                  hosts:
                    your-server:
                      data_disk: /dev/sdb
          when: selected_disk is none or selected_disk == ''

        - name: Set disk variables
          set_fact:
            data_disk: "/dev/{{ selected_disk.name }}"
            disk_size_gb: "{{ (selected_disk.size | int / 1073741824) | round(1) }}"
            has_fs: "{{ (selected_disk.fstype | default('')) != '' }}"
            current_mountpoint: "{{ selected_disk.mountpoint | default('') }}"

        - name: Show selected disk
          debug:
            msg: "Using disk {{ data_disk }} ({{ disk_size_gb }}GB, has filesystem: {{ has_fs }}, currently mounted: {{ current_mountpoint or 'no' }})"

        - name: Unmount if currently mounted elsewhere
          mount:
            path: "{{ current_mountpoint }}"
            state: unmounted
          when: current_mountpoint != '' and current_mountpoint != data_mount_point

        - name: Format disk if no filesystem
          filesystem:
            fstype: ext4
            dev: "{{ data_disk }}"
            force: no
          when: not has_fs

        - name: Create mount point
          file:
            path: "{{ data_mount_point }}"
            state: directory
            owner: "{{ deploy_user | default('deploy') }}"
            group: "{{ deploy_user | default('deploy') }}"
            mode: '0755'
          # /data 属于 deploy，方便日常操作：
          # 1. deploy 可以直接访问 /data/backups/ 等目录，无需 sudo
          # 2. Docker daemon 会自己创建并管理 /data/docker/ (root:root)
          # 3. 各自管理各自的子目录，不冲突

        - name: Add to fstab and mount
          mount:
            path: "{{ data_mount_point }}"
            src: "{{ data_disk }}"
            fstype: ext4
            opts: defaults,noatime
            state: mounted

        - name: Verify mount
          command: df -h "{{ data_mount_point }}"
          register: df_output
          changed_when: false

        - name: Show success
          debug:
            msg: |
              ✅ Data disk mounted successfully!
              {{ df_output.stdout_lines | join('\n              ') }}
