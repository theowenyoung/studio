---
- name: Deploy Application
  hosts: all
  gather_facts: yes
  
  pre_tasks:
    - name: Create application directories
      include_tasks: ../tasks/create-app-directories.yml
      tags: [app-setup]
  
  tasks:
    # 可选择性部署服务 - 使用独立的playbooks
    - name: Deploy PostgreSQL Database
      include: deploy-database.yml
      when: deploy_database | default(true)
      tags: [postgresql, database, services]
    
    - name: Deploy Redis Cache
      include: deploy-redis.yml
      when: deploy_redis | default(true)
      tags: [redis, cache, services]
    
    - name: Deploy Caddy Proxy
      include: deploy-caddy.yml
      when: deploy_caddy | default(true)
      tags: [caddy, proxy, services]
    
    - name: Clone/Update application code
      git:
        repo: "{{ app_git_repo }}"
        dest: "{{ app_directory }}"
        version: "{{ app_git_branch }}"
        force: yes
      become_user: deploy
      tags: [git, deploy]
    
    - name: Deploy Web Application
      include_tasks: ../tasks/deploy-webapp.yml
      tags: [docker, deploy]
    
    - name: Run health check
      include_tasks: ../tasks/health-check.yml
      tags: [health-check]
