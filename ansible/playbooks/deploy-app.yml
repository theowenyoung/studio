---
- name: Deploy Application
  hosts: all
  gather_facts: yes
  
  pre_tasks:
    - name: Create application directories
      include_tasks: ../tasks/create-app-directories.yml
      tags: [app-setup]
  
  roles:
    # 数据库服务
    - role: geerlingguy.postgresql
      tags: [postgresql, database]
    
    - role: geerlingguy.redis
      tags: [redis, cache]
    
    # Caddy反向代理
    - role: maxhoesel.caddy.caddy_server
      tags: [caddy, proxy]
  
  tasks:
    - name: Clone/Update application code
      git:
        repo: "{{ app_git_repo }}"
        dest: "{{ app_directory }}"
        version: "{{ app_git_branch }}"
        force: yes
      become_user: deploy
      tags: [git, deploy]
    
    - name: Deploy Web Application
      include_tasks: ../tasks/deploy-webapp.yml
      tags: [docker, deploy]
    
    - name: Manage databases
      include_tasks: ../tasks/manage-databases.yml
      tags: [database, deploy]
    
    - name: Run health check
      include_tasks: ../tasks/health-check.yml
      tags: [health-check]
