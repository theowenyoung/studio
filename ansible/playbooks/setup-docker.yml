---
# =====================================
# Docker 环境和工具准备 - 修正版
# =====================================
- name: Setup Docker Environment and Tools
  hosts: all
  gather_facts: no
  become: yes
  vars:
    # 设置为 true 将会执行“核弹级”清理（只保留 volumes，清除镜像和容器）
    # 建议默认 false，防止误删镜像导致重新拉取时间过长
    # 运行时可通过 -e reset_docker=true 强制开启
    reset_docker: true 

  tasks:
    # =====================================
    # 1. 基础检查
    # =====================================
    - name: Verify /data mount
      include_tasks: ../tasks/verify-data-mount.yml
      tags: [always]

    # =====================================
    # 2. 停止 Docker (配置前必须停止)
    # =====================================
    - name: Stop Docker service
      systemd:
        name: docker
        state: stopped
      ignore_errors: yes
      tags: [docker-setup]

    # =====================================
    # 3. 核心修复逻辑：安全清理旧数据
    #    只保留 volumes，删除其他所有 Docker 内部数据
    # =====================================
    - name: HARD RESET - Clean Docker root but PRESERVE volumes
      shell: |
        echo "Performing Hard Reset of Docker Data..."
        
        # 确保目录存在
        if [ -d "/data/docker" ]; then
            # 1. 查找除了 'volumes' 以外的所有一级子目录并删除
            # -mindepth 1: 不删除 /data/docker 本身
            # -maxdepth 1: 只看第一层
            # -not -name 'volumes': 排除 volumes 目录
            find /data/docker -mindepth 1 -maxdepth 1 -type d -not -name 'volumes' -exec rm -rf '{}' +
            
            # 2. 删除所有非目录文件 (如之前的 daemon.json 或锁文件)
            find /data/docker -mindepth 1 -maxdepth 1 -type f -delete
            
            echo "✅ Docker data wiped, volumes preserved."
        else
            echo "Directory /data/docker does not exist, skipping clean."
        fi
      # 触发条件：
      # 1. 显式传入了 reset_docker=true
      # 2. 或者检测到 overlay2 目录缺失/损坏（通过之前的错误推断，这里我们简单依赖变量）
      when: reset_docker | bool
      tags: [cleanup]

    # =====================================
    # 4. 配置 Docker
    # =====================================
    - name: Ensure Docker data directory exists
      file:
        path: /data/docker
        state: directory
        mode: '0710'
        owner: root
        group: root
      tags: [docker-config]

    - name: Ensure Docker config directory exists
      file:
        path: /etc/docker
        state: directory
        mode: '0755'
      tags: [docker-config]

    - name: Configure Docker daemon
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "data-root": "/data/docker",
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2"
          }
        mode: '0644'
      tags: [docker-config]

    # =====================================
    # 5. 启动 Docker
    # =====================================
    - name: Start and Enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
        daemon_reload: yes
      tags: [docker-service]

    - name: Wait for Docker to be ready
      command: docker info
      register: docker_ready
      until: docker_ready.rc == 0
      retries: 10
      delay: 2
      changed_when: false
      tags: [docker-service]

    # =====================================
    # 6. 常规清理 (Soft Prune)
    #    即使不进行 Hard Reset，也清理悬空资源
    # =====================================
    - name: Prune Docker system (Soft Clean)
      shell: |
        # 清理悬空的镜像、停止的容器、未使用的网络
        # 注意：这里不加 --volumes，确保数据绝对安全
        docker system prune -a -f
      when: not (reset_docker | bool)
      tags: [cleanup]

    # =====================================
    # 7. 网络配置
    # =====================================
    - name: Create shared Docker network
      community.docker.docker_network:
        name: shared
        driver: bridge
        ipam_config:
          - subnet: "172.30.0.0/16"
      # 使用 ignore_errors 防止网络已存在但参数微小差异导致的报错
      ignore_errors: yes 
      tags: [network]

    # =====================================
    # 8. 安装工具
    # =====================================
    - name: Install docker-rollout
      include_tasks: ../tasks/install-docker-rollout.yml
      tags: [docker-rollout]

    - name: Info
      debug:
        msg: 
          - "✅ Docker 准备就绪"
          - "数据目录: /data/docker"
          - "Volumes 状态: {{ '已保留' if (reset_docker | bool) else '未变动' }}"
