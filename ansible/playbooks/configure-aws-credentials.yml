---
- name: Configure AWS Credentials on Server
  hosts: all
  become: yes

  tasks:
    - name: Fetch ECR Key ID from Parameter Store
      shell: aws ssm get-parameter --name "/common/ECR_KEY_ID" --region us-west-2 --with-decryption --query 'Parameter.Value' --output text
      register: ecr_key_id_result
      delegate_to: localhost
      become: no
      run_once: true
      changed_when: false

    - name: Fetch ECR Key Secret from Parameter Store
      shell: aws ssm get-parameter --name "/common/ECR_KEY_SECRET" --region us-west-2 --with-decryption --query 'Parameter.Value' --output text
      register: ecr_key_secret_result
      delegate_to: localhost
      become: no
      run_once: true
      changed_when: false

    - name: Set ECR credentials facts
      set_fact:
        aws_ecr_key_id: "{{ ecr_key_id_result.stdout }}"
        aws_ecr_key_secret: "{{ ecr_key_secret_result.stdout }}"
    - name: Ensure .aws directory exists for deploy user
      file:
        path: "/home/{{ deploy_user }}/.aws"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0700'
      become_user: "{{ deploy_user }}"

    - name: Configure AWS credentials
      template:
        src: ../templates/aws_credentials.j2
        dest: "/home/{{ deploy_user }}/.aws/credentials"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0600'
      become_user: "{{ deploy_user }}"

    - name: Configure AWS config
      template:
        src: ../templates/aws_config.j2
        dest: "/home/{{ deploy_user }}/.aws/config"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0600'
      become_user: "{{ deploy_user }}"

    - name: Check if AWS CLI is installed
      shell: which aws
      register: aws_cli_check
      become_user: "{{ deploy_user }}"
      failed_when: false
      changed_when: false

    - name: Verify AWS credentials
      shell: |
        aws sts get-caller-identity
      become_user: "{{ deploy_user }}"
      register: aws_verify
      when: aws_cli_check.rc == 0
      changed_when: false

    - name: Display AWS identity
      debug:
        msg: "✅ AWS credentials configured. Identity: {{ aws_verify.stdout | from_json | json_query('UserId') }}"
      when: aws_cli_check.rc == 0 and aws_verify.stdout is defined

    - name: Display success message (without verification)
      debug:
        msg: "✅ AWS credentials configured successfully. (AWS CLI not installed yet, will be installed during server-init)"
      when: aws_cli_check.rc != 0
