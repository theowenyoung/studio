---
- name: Deploy External Application
  hosts: all
  gather_facts: no

  vars:
    service_base: "{{ service_base }}"
    service_name: "{{ service_name }}"
    local_dist: "{{ playbook_dir }}/../../external-apps/{{ service_base }}/deploy-dist"
    remote_dir: "/srv/studio/external-apps/{{ service_name }}"

  tasks:
    - debug:
        msg: "ðŸš€ Deploying {{ service_name }}"

    - name: Ensure service directory exists
      file:
        path: "{{ remote_dir }}"
        state: directory
        owner: "{{ deploy_user | default('deploy') }}"
        group: "{{ deploy_user | default('deploy') }}"
        mode: '0755'

    # ===== Sync files =====
    - name: Sync deploy-dist to server
      synchronize:
        src: "{{ local_dist }}/"
        dest: "{{ remote_dir }}/"
        delete: yes
        owner: no
        group: no

    # ===== Docker operations =====
    - name: Pull new images
      shell: |
        cd {{ remote_dir }}
        docker compose pull --quiet
      register: pull_result
      changed_when: false

    # ===== Deploy service =====
    - name: Docker compose up with remove-orphans
      shell: |
        cd {{ remote_dir }}
        docker compose up -d --remove-orphans
      register: deploy_result

    - debug:
        msg: "{{ deploy_result.stdout_lines }}"

    # ===== Health check =====
    # Note: docker service name is now dynamic (service_name), injected via envsubst in build.sh
    - name: Wait for container to be healthy
      shell: |
        cd {{ remote_dir }}
        docker compose ps {{ service_name }} --format json 2>/dev/null | jq -r '.State // empty' | head -1
      register: container_state
      until: container_state.stdout == "running" or container_state.stdout == "running (healthy)"
      retries: 12
      delay: 5
      failed_when: false

    - name: Get container logs if deployment failed
      shell: |
        cd {{ remote_dir }}
        docker compose logs --tail=50 {{ service_name }}
      register: container_logs
      when: container_state.stdout != "running" and container_state.stdout != "running (healthy)"

    - name: Display container logs
      debug:
        msg: "{{ container_logs.stdout_lines }}"
      when: container_logs is defined and container_logs.stdout_lines is defined

    - name: Fail if deployment unsuccessful
      fail:
        msg: "âŒ Deployment of {{ service_name }} failed! Check logs above."
      when: container_state.stdout != "running" and container_state.stdout != "running (healthy)"

    - name: Display success message
      debug:
        msg: "âœ… Successfully deployed {{ service_name }}"
      when: container_state.stdout == "running" or container_state.stdout == "running (healthy)"

    # ===== Preview Environment: Auto-generate Caddy config =====
    # routes is a JSON string: '[{"domain": "xxx", "port": "3000"}, ...]'
    - name: Generate Caddy config for preview environment
      copy:
        content: |
          # Preview: {{ service_name }}
          # Auto-generated by deploy-external-app.yml
          {% for route in (routes | from_json) %}
          {{ route.domain }} {
              import app_cache
              import resilient_proxy {{ service_name }}:{{ route.port }}
          }
          {% endfor %}
        dest: "/srv/studio/infra-apps/caddy/config/preview/{{ service_name }}.caddy"
        owner: "{{ deploy_user | default('deploy') }}"
        group: "{{ deploy_user | default('deploy') }}"
        mode: '0644'
      when: target_env == "preview" and (routes | from_json) | length > 0
      register: caddy_config_created

    - name: Reload Caddy config for preview environment
      shell: |
        cd /srv/studio/infra-apps/caddy
        docker compose exec -T caddy caddy reload --config /etc/caddy/Caddyfile
      when: target_env == "preview" and caddy_config_created.changed
      register: caddy_reload_result
      failed_when: false

    - name: Display Caddy reload status
      debug:
        msg: "ðŸ”„ Caddy config reloaded for {{ (routes | from_json) | map(attribute='domain') | join(', ') }}"
      when: target_env == "preview" and caddy_config_created.changed
