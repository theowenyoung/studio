---
# æ¸…ç† Dockerï¼ˆå®Œå…¨å¸è½½ + å¤‡ä»½æ•°æ®ï¼‰
# ä½¿ç”¨åœºæ™¯ï¼šç³»ç»Ÿé‡å»ºå‰å½»åº•æ¸…ç† Docker
- name: Clean Docker (Uninstall + Backup Data)
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    docker_data_root: /data/docker

  tasks:
    # 1. å¤‡ä»½æ•°æ®ç›®å½•
    - name: Check if Docker data directory exists
      stat:
        path: "{{ docker_data_root }}"
      register: docker_data_dir

    - name: Create backup directory name with timestamp
      set_fact:
        backup_path: "{{ docker_data_root }}.old-{{ ansible_date_time.iso8601_basic_short }}"
      when: docker_data_dir.stat.exists

    - name: Move Docker data directory to backup
      command: mv "{{ docker_data_root }}" "{{ backup_path }}"
      when: docker_data_dir.stat.exists

    # 2. å®Œå…¨å¸è½½ Dockerï¼ˆå®˜æ–¹æ¨èæ–¹å¼ï¼‰
    # apt purge ä¼šè‡ªåŠ¨ï¼šåœæ­¢æœåŠ¡ã€æ¸…ç† systemdã€åˆ é™¤ç½‘ç»œæ¥å£
    - name: Purge Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
          - docker-ce-rootless-extras
        state: absent
        purge: yes
      ignore_errors: yes

    # 3. æ¸…ç†é»˜è®¤æ•°æ®ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    - name: Remove default Docker directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/docker
        - /var/lib/containerd
      ignore_errors: yes

    # 4. æ¸…ç†é…ç½®æ–‡ä»¶
    - name: Remove Docker config
      file:
        path: /etc/docker/daemon.json
        state: absent
      ignore_errors: yes

    - name: Display completion message
      debug:
        msg:
          - "âœ… Docker å·²å®Œå…¨å¸è½½"
          - ""
          - "{% if docker_data_dir.stat.exists %}ğŸ“¦ æ•°æ®å·²å¤‡ä»½åˆ°: {{ backup_path }}{% else %}â„¹ï¸  æ— æ•°æ®éœ€è¦å¤‡ä»½{% endif %}"
          - ""
          - "ä¸‹ä¸€æ­¥ï¼š"
          - "  mise run server-update  # é‡æ–°å®‰è£…å’Œé…ç½® Docker"
          - ""
          - "ğŸ’¡ å¦‚éœ€æ¢å¤æ•°æ®ï¼š"
          - "  mv {{ backup_path | default(docker_data_root + '.old-*') }} {{ docker_data_root }}"
