---
# æ¸…ç† Docker æ•°æ®ç›®å½•ï¼ˆç§»åŠ¨åˆ° .old å¤‡ä»½ï¼‰
# ä½¿ç”¨åœºæ™¯ï¼šç³»ç»Ÿé‡å»ºå‰å¤‡ä»½ Docker æ•°æ®
- name: Clean Docker Data Directory
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    docker_data_root: /data/docker

  tasks:
    - name: Check if Docker is running
      systemd:
        name: docker
      register: docker_service
      ignore_errors: yes

    - name: Stop Docker service
      systemd:
        name: docker
        state: stopped
      when: docker_service.status.ActiveState == "active"
      tags: [docker-stop]

    - name: Stop Docker socket
      systemd:
        name: docker.socket
        state: stopped
      ignore_errors: yes
      tags: [docker-stop]

    - name: Check if Docker data directory exists
      stat:
        path: "{{ docker_data_root }}"
      register: docker_data_dir

    - name: Create backup directory name with timestamp
      set_fact:
        backup_path: "{{ docker_data_root }}.old-{{ ansible_date_time.iso8601_basic_short }}"
      when: docker_data_dir.stat.exists

    - name: Move Docker data directory to backup
      command: mv "{{ docker_data_root }}" "{{ backup_path }}"
      when: docker_data_dir.stat.exists
      tags: [backup]

    - name: Display backup location
      debug:
        msg:
          - "âœ… Docker æ•°æ®å·²å¤‡ä»½"
          - "åŸè·¯å¾„: {{ docker_data_root }}"
          - "å¤‡ä»½è·¯å¾„: {{ backup_path }}"
          - ""
          - "âš ï¸  Docker æœåŠ¡å·²åœæ­¢"
          - "ä¸‹ä¸€æ­¥ï¼š"
          - "  1. æ‰§è¡Œç³»ç»Ÿé‡å»ºæ“ä½œ"
          - "  2. è¿è¡Œ mise run server-init åˆå§‹åŒ–æœåŠ¡å™¨"
          - ""
          - "ğŸ’¡ å¦‚éœ€æ¢å¤æ•°æ®ï¼š"
          - "  mv {{ backup_path }} {{ docker_data_root }}"
      when: docker_data_dir.stat.exists

    - name: Show message if directory doesn't exist
      debug:
        msg:
          - "â„¹ï¸  Docker æ•°æ®ç›®å½•ä¸å­˜åœ¨"
          - "è·¯å¾„: {{ docker_data_root }}"
          - "æ— éœ€å¤‡ä»½"
      when: not docker_data_dir.stat.exists
