version: '3.8'

services:
  app:
    image: "{{ app_name }}:{{ app_git_branch | default('latest') }}"
    container_name: "{{ app_name }}"
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:{{ app_port }}:{{ app_port }}"
    environment:
      - NODE_ENV={{ deploy_environment }}
      - PORT={{ app_port }}
    volumes:
      - ./data:/app/data
      - ./public:/app/public
    networks:
      - web
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ app_port }}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.example.environment={{ deploy_environment }}"
      - "com.example.test_id={{ test_id | default('none') }}"

networks:
  web:
    external: true
  backend:
    external: true
