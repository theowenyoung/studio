name: Deploy External Applications

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      service:
        description: "External app to deploy"
        required: true
        type: choice
        options:
          - "all"
          - "meilisearch"
          - "owen-blog"

  # Webhook è§¦å‘ï¼ˆä¾‹å¦‚ï¼šåšå®¢ä»“åº“æ›´æ–°åŽè§¦å‘ï¼‰
  repository_dispatch:
    types: [deploy-external-app]

env:
  ECR_REGISTRY: 912951144733.dkr.ecr.us-west-2.amazonaws.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ç¼“å­˜ mise å·¥å…·
      - name: Cache mise
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('mise.toml') }}

      # å®‰è£… mise
      - name: Install mise
        run: |
          curl https://mise.run | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # æ¿€æ´» mise çŽ¯å¢ƒ
      - name: Setup mise
        run: |
          mise install

      # ç¼“å­˜ Ansible Galaxy ä¾èµ–
      - name: Cache Ansible Galaxy dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.ansible/roles
            ~/.ansible/collections
          key: ansible-galaxy-${{ hashFiles('ansible/requirements.yml') }}

      # å®‰è£… Ansible Galaxy ä¾èµ–
      - name: Install Ansible Galaxy dependencies
        run: |
          ansible-galaxy install -r ansible/requirements.yml

      # é…ç½® AWSï¼ˆç”¨äºŽ ECR å’Œ Parameter Storeï¼‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      # ä»Ž Parameter Store è¯»å– SSH Key
      - name: Load SSH key from Parameter Store
        run: |
          DEPLOY_SSH_KEY=$(aws ssm get-parameter --name "/studio-prod/DEPLOY_SSH_KEY" --with-decryption --query "Parameter.Value" --output text)

          # ä¿å­˜ SSH key åˆ°æ–‡ä»¶
          mkdir -p ~/.ssh
          echo "${DEPLOY_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "âœ… SSH key loaded"

      # ç™»å½• ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-west-2 | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      # ç¡®å®šè¦éƒ¨ç½²çš„æœåŠ¡
      - name: Determine deployment target
        id: target
        run: |
          # workflow_dispatch è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICE="${{ inputs.service }}"
          # repository_dispatch è§¦å‘ï¼ˆä»Ž webhook payload è¯»å–ï¼‰
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SERVICE="${{ github.event.client_payload.service }}"
            if [ -z "$SERVICE" ]; then
              echo "âŒ Error: service not specified in webhook payload"
              exit 1
            fi
          fi

          echo "service=${SERVICE}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying: ${SERVICE}"

      # éƒ¨ç½²æœåŠ¡
      - name: Deploy ${{ steps.target.outputs.service }}
        run: |
          SERVICE="${{ steps.target.outputs.service }}"

          if [ "$SERVICE" = "all" ]; then
            echo "ðŸš€ Deploying all external apps..."
            for app in meilisearch owen-blog; do
              echo "Deploying ${app}..."
              mise run build-${app}
              mise run deploy-${app}
            done
          else
            echo "ðŸš€ Deploying ${SERVICE}..."
            mise run build-${SERVICE}
            mise run deploy-${SERVICE}
          fi
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
          ANSIBLE_SSH_PRIVATE_KEY_FILE: ~/.ssh/id_rsa

      # éƒ¨ç½²ç»“æžœé€šçŸ¥
      - name: Deployment summary
        if: always()
        run: |
          SERVICE="${{ steps.target.outputs.service }}"

          echo "### External App Deployment Result ðŸŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ä»Ž DEPLOY_SUMMARY.txt è¯»å– URL
          if [ "$SERVICE" = "all" ]; then
            # éƒ¨ç½²æ‰€æœ‰æœåŠ¡æ—¶ï¼Œåˆå¹¶æ‰€æœ‰ summary
            echo "ðŸ”— **URLs:**" >> $GITHUB_STEP_SUMMARY
            for app in meilisearch owen-blog; do
              SUMMARY_FILE="external-apps/${app}/deploy-dist/DEPLOY_SUMMARY.txt"
              if [ -f "$SUMMARY_FILE" ]; then
                while IFS= read -r url; do
                  echo "- [${url}](${url})" >> $GITHUB_STEP_SUMMARY
                done < "$SUMMARY_FILE"
              else
                echo "- ${app} (internal service)" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            SUMMARY_FILE="external-apps/${SERVICE}/deploy-dist/DEPLOY_SUMMARY.txt"
            if [ -f "$SUMMARY_FILE" ]; then
              echo "ðŸ”— **URLs:**" >> $GITHUB_STEP_SUMMARY
              while IFS= read -r url; do
                echo "- [${url}](${url})" >> $GITHUB_STEP_SUMMARY
              done < "$SUMMARY_FILE"
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "- Service: \`${SERVICE}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "- Triggered by: Webhook" >> $GITHUB_STEP_SUMMARY
            echo "- Source repo: ${{ github.event.client_payload.repository || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
