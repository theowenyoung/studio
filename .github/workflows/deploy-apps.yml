name: Deploy Applications

on:
  push:
    branches: [main]
    paths:
      - 'js-apps/**'
      - 'js-packages/**'

  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'js-apps/**'
      - 'js-packages/**'

  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: true
        type: choice
        options:
          - 'auto'        # åŸºäºŽ paths è‡ªåŠ¨æ£€æµ‹
          - 'all'         # éƒ¨ç½²æ‰€æœ‰ apps
          - 'hono-demo'
          - 'proxy'
          - 'blog'
          - 'storefront'
          - 'admin'
          - 'api'

env:
  ECR_REGISTRY: 912951144733.dkr.ecr.us-west-2.amazonaws.com

jobs:
  # æ£€æµ‹å˜æ›´
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      deploy_env: ${{ steps.set-env.outputs.deploy_env }}
      branch_clean: ${{ steps.set-env.outputs.branch_clean }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä»¥ä¾¿ git diff èƒ½æ‰¾åˆ° before commit

      # ç¡®å®šéƒ¨ç½²çŽ¯å¢ƒ
      - name: Determine deployment environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
            DEPLOY_ENV="preview"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            BRANCH="main"
            DEPLOY_ENV="prod"
          else
            BRANCH="${{ github.ref_name }}"
            DEPLOY_ENV="preview"
          fi

          # æ¸…æ´—åˆ†æ”¯å
          BRANCH_CLEAN=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-30)

          echo "deploy_env=$DEPLOY_ENV" >> $GITHUB_OUTPUT
          echo "branch_clean=$BRANCH_CLEAN" >> $GITHUB_OUTPUT
          echo "Deploy environment: $DEPLOY_ENV"
          echo "Branch: $BRANCH (clean: $BRANCH_CLEAN)"

      # æ£€æµ‹å˜æ›´çš„æœåŠ¡ï¼ˆä½¿ç”¨ git diffï¼‰
      - name: Detect changed services
        id: detect-changes
        run: |
          # è‡ªåŠ¨å‘çŽ° js-apps ä¸‹çš„æ‰€æœ‰æœåŠ¡
          ALL_SERVICES=$(ls -1 js-apps | tr '\n' ' ')
          echo "All services: $ALL_SERVICES"

          # èŽ·å–å˜æ›´çš„æ–‡ä»¶
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR: æ¯”è¾ƒ base å’Œ head
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          elif [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            # workflow_dispatch: æ¯”è¾ƒæœ€è¿‘ä¸¤æ¬¡ commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # æ£€æŸ¥æ˜¯å¦æœ‰å…±äº«åŒ…å˜æ›´
          SHARED_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -q "^js-packages/"; then
            SHARED_CHANGED="true"
            echo "Shared packages changed: true"
          fi

          # æ£€æµ‹å“ªäº›æœåŠ¡å˜æ›´äº†
          CHANGED_SERVICES=""
          for svc in $ALL_SERVICES; do
            if echo "$CHANGED_FILES" | grep -q "^js-apps/$svc/"; then
              CHANGED_SERVICES="$CHANGED_SERVICES $svc"
              echo "Service changed: $svc"
            fi
          done

          echo "all_services=$ALL_SERVICES" >> $GITHUB_OUTPUT
          echo "changed_services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "shared_changed=$SHARED_CHANGED" >> $GITHUB_OUTPUT

      # æž„å»ºéƒ¨ç½²çŸ©é˜µ
      - name: Set deployment matrix
        id: set-matrix
        run: |
          ALL_SERVICES="${{ steps.detect-changes.outputs.all_services }}"
          CHANGED_SERVICES="${{ steps.detect-changes.outputs.changed_services }}"
          SHARED_CHANGED="${{ steps.detect-changes.outputs.shared_changed }}"

          # æ‰‹åŠ¨è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET="${{ inputs.target }}"

            if [ "$TARGET" = "all" ]; then
              DEPLOY_SERVICES="$ALL_SERVICES"
            elif [ "$TARGET" = "auto" ]; then
              # åŸºäºŽæ–‡ä»¶å˜æ›´è‡ªåŠ¨æ£€æµ‹
              if [ "$SHARED_CHANGED" = "true" ]; then
                DEPLOY_SERVICES="$ALL_SERVICES"
              else
                DEPLOY_SERVICES="$CHANGED_SERVICES"
              fi
            else
              DEPLOY_SERVICES="$TARGET"
            fi
          else
            # Push æˆ– PR äº‹ä»¶ï¼šè‡ªåŠ¨æ£€æµ‹
            if [ "$SHARED_CHANGED" = "true" ]; then
              DEPLOY_SERVICES="$ALL_SERVICES"
              echo "Shared packages changed, deploying all services"
            else
              DEPLOY_SERVICES="$CHANGED_SERVICES"
              echo "Deploying only changed services"
            fi
          fi

          # åŽ»é™¤å¤šä½™ç©ºæ ¼
          DEPLOY_SERVICES=$(echo "$DEPLOY_SERVICES" | xargs)

          # æž„å»º JSON matrix
          if [ -z "$DEPLOY_SERVICES" ]; then
            MATRIX='{"include":[]}'
            echo "No services to deploy"
          else
            MATRIX_ITEMS=$(echo $DEPLOY_SERVICES | tr ' ' '\n' | sed 's/.*/{\"service\":\"&\"}/' | paste -sd ',' -)
            MATRIX="{\"include\":[${MATRIX_ITEMS}]}"
            echo "Services to deploy: $DEPLOY_SERVICES"
          fi

          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT
          echo "Deployment matrix: ${MATRIX}"

  # å¹¶è¡Œéƒ¨ç½²
  deploy:
    needs: detect
    if: needs.detect.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
      fail-fast: false
    outputs:
      deployed_services: ${{ steps.collect.outputs.services }}

    steps:
      - uses: actions/checkout@v4

      # ç¼“å­˜ mise å·¥å…·
      - name: Cache mise
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('mise.toml') }}

      # å®‰è£… mise
      - name: Install mise
        run: |
          curl https://mise.run | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # æ¿€æ´» mise çŽ¯å¢ƒ
      - name: Setup mise
        run: |
          mise install

      # ç¼“å­˜ pnpm storeï¼ˆæŒ‰ç…§æœ€ä½³å®žè·µï¼‰
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      # é…ç½® AWSï¼ˆç”¨äºŽ ECR å’Œ Parameter Storeï¼‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      # ä»Ž Parameter Store è¯»å–é…ç½®
      - name: Load configuration from Parameter Store
        id: load-config
        run: |
          echo "Loading configuration from AWS Parameter Store..."

          # æ ¹æ®çŽ¯å¢ƒé€‰æ‹©é…ç½®è·¯å¾„
          if [ "${{ needs.detect.outputs.deploy_env }}" = "prod" ]; then
            PARAM_PATH="/studio-prod/"
          else
            PARAM_PATH="/studio-dev/"
          fi

          # è¯»å–éƒ¨ç½²é…ç½®
          DEPLOY_HOST=$(aws ssm get-parameter --name "${PARAM_PATH}DEPLOY_HOST" --query "Parameter.Value" --output text)
          DEPLOY_USER=$(aws ssm get-parameter --name "${PARAM_PATH}DEPLOY_USER" --query "Parameter.Value" --output text)
          DEPLOY_SSH_KEY=$(aws ssm get-parameter --name "${PARAM_PATH}DEPLOY_SSH_KEY" --with-decryption --query "Parameter.Value" --output text)

          echo "DEPLOY_HOST=${DEPLOY_HOST}" >> $GITHUB_ENV
          echo "DEPLOY_USER=${DEPLOY_USER}" >> $GITHUB_ENV

          # ä¿å­˜ SSH key åˆ°æ–‡ä»¶
          mkdir -p ~/.ssh
          echo "${DEPLOY_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "âœ… Configuration loaded successfully"
          echo "   Environment: ${{ needs.detect.outputs.deploy_env }}"
          echo "   Host: ${DEPLOY_HOST}"
          echo "   User: ${DEPLOY_USER}"

      # ç™»å½• ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-west-2 | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      # é…ç½® SSH known_hosts
      - name: Setup SSH known_hosts
        run: |
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      # ç¡®ä¿æ•°æ®åº“å­˜åœ¨ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
      - name: Ensure database exists (db-admin)
        run: |
          mise run deploy-db-admin
        env:
          ANSIBLE_SSH_PRIVATE_KEY_FILE: ~/.ssh/id_rsa

      # éƒ¨ç½²æœåŠ¡
      - name: Deploy ${{ matrix.service }}
        run: |
          mise run deploy-${{ matrix.service }}
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
          ANSIBLE_SSH_PRIVATE_KEY_FILE: ~/.ssh/id_rsa

      # æ”¶é›†éƒ¨ç½²çš„æœåŠ¡ï¼ˆç”¨äºŽ PR è¯„è®ºï¼‰
      - name: Collect deployed service
        id: collect
        run: |
          echo "services=${{ matrix.service }}" >> $GITHUB_OUTPUT

      # éƒ¨ç½²ç»“æžœé€šçŸ¥
      - name: Deployment summary
        if: always()
        run: |
          echo "### Deployment Result: ${{ matrix.service }} ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Service: \`${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: \`${{ needs.detect.outputs.deploy_env }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # PR è¯„è®ºé¢„è§ˆ URL
  comment:
    needs: [detect, deploy]
    if: github.event_name == 'pull_request' && needs.detect.outputs.deploy_env == 'preview'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment preview URLs on PR
        uses: actions/github-script@v7
        with:
          script: |
            const branchClean = '${{ needs.detect.outputs.branch_clean }}';
            const matrix = ${{ needs.detect.outputs.matrix }};
            const services = matrix.include.map(item => item.service);

            // ç”Ÿæˆé¢„è§ˆ URL åˆ—è¡¨
            // æ ¼å¼: {service}--{branch}.preview.owenyoung.com (åŒä¸­åˆ’çº¿åˆ†éš”)
            const urls = services.map(service => {
              const domain = `${service}--${branchClean}.preview.owenyoung.com`;
              return `- **${service}**: https://${domain}`;
            }).join('\n');

            const body = `## ðŸš€ Preview Deployment

            Your changes have been deployed to the preview environment!

            ### Preview URLs
            ${urls}

            ### Details
            - **Branch**: \`${{ github.head_ref }}\`
            - **Commit**: \`${{ github.sha }}\`
            - **Environment**: preview

            > â„¹ï¸ Preview environments are automatically cleaned up when the PR is merged or closed.
            > Use \`mise run preview-delete ${branchClean}\` to manually clean up.
            `;

            // æŸ¥æ‰¾å·²æœ‰çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployment')
            );

            if (botComment) {
              // æ›´æ–°å·²æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
