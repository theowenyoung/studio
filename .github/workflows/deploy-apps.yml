name: Deploy Applications

on:
  push:
    branches: [main]
    paths:
      - 'js-apps/**'
      - 'js-packages/**'

  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: true
        type: choice
        options:
          - 'auto'        # åŸºäºŽ paths è‡ªåŠ¨æ£€æµ‹
          - 'all'         # éƒ¨ç½²æ‰€æœ‰ apps
          - 'hono-demo'
          - 'proxy'
          - 'blog'
          - 'storefront'
          - 'admin'
          - 'api'

env:
  ECR_REGISTRY: 912951144733.dkr.ecr.us-west-2.amazonaws.com

jobs:
  # æ£€æµ‹å˜æ›´
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä»¥ä¾¿ git diff èƒ½æ‰¾åˆ° before commit

      # æ£€æµ‹å˜æ›´çš„æœåŠ¡ï¼ˆä½¿ç”¨ git diffï¼‰
      - name: Detect changed services
        id: detect-changes
        run: |
          # è‡ªåŠ¨å‘çŽ° js-apps ä¸‹çš„æ‰€æœ‰æœåŠ¡
          ALL_SERVICES=$(ls -1 js-apps | tr '\n' ' ')
          echo "All services: $ALL_SERVICES"

          # èŽ·å–å˜æ›´çš„æ–‡ä»¶
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            # workflow_dispatch: æ¯”è¾ƒæœ€è¿‘ä¸¤æ¬¡ commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # æ£€æŸ¥æ˜¯å¦æœ‰å…±äº«åŒ…å˜æ›´
          SHARED_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -q "^js-packages/"; then
            SHARED_CHANGED="true"
            echo "Shared packages changed: true"
          fi

          # æ£€æµ‹å“ªäº›æœåŠ¡å˜æ›´äº†
          CHANGED_SERVICES=""
          for svc in $ALL_SERVICES; do
            if echo "$CHANGED_FILES" | grep -q "^js-apps/$svc/"; then
              CHANGED_SERVICES="$CHANGED_SERVICES $svc"
              echo "Service changed: $svc"
            fi
          done

          echo "all_services=$ALL_SERVICES" >> $GITHUB_OUTPUT
          echo "changed_services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "shared_changed=$SHARED_CHANGED" >> $GITHUB_OUTPUT

      # æž„å»ºéƒ¨ç½²çŸ©é˜µ
      - name: Set deployment matrix
        id: set-matrix
        run: |
          ALL_SERVICES="${{ steps.detect-changes.outputs.all_services }}"
          CHANGED_SERVICES="${{ steps.detect-changes.outputs.changed_services }}"
          SHARED_CHANGED="${{ steps.detect-changes.outputs.shared_changed }}"

          # æ‰‹åŠ¨è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET="${{ inputs.target }}"

            if [ "$TARGET" = "all" ]; then
              DEPLOY_SERVICES="$ALL_SERVICES"
            elif [ "$TARGET" = "auto" ]; then
              # åŸºäºŽæ–‡ä»¶å˜æ›´è‡ªåŠ¨æ£€æµ‹
              if [ "$SHARED_CHANGED" = "true" ]; then
                DEPLOY_SERVICES="$ALL_SERVICES"
              else
                DEPLOY_SERVICES="$CHANGED_SERVICES"
              fi
            else
              DEPLOY_SERVICES="$TARGET"
            fi
          else
            # Push äº‹ä»¶ï¼šè‡ªåŠ¨æ£€æµ‹
            if [ "$SHARED_CHANGED" = "true" ]; then
              DEPLOY_SERVICES="$ALL_SERVICES"
              echo "Shared packages changed, deploying all services"
            else
              DEPLOY_SERVICES="$CHANGED_SERVICES"
              echo "Deploying only changed services"
            fi
          fi

          # åŽ»é™¤å¤šä½™ç©ºæ ¼
          DEPLOY_SERVICES=$(echo "$DEPLOY_SERVICES" | xargs)

          # æž„å»º JSON matrix
          if [ -z "$DEPLOY_SERVICES" ]; then
            MATRIX='{"include":[]}'
            echo "No services to deploy"
          else
            MATRIX_ITEMS=$(echo $DEPLOY_SERVICES | tr ' ' '\n' | sed 's/.*/{\"service\":\"&\"}/' | paste -sd ',' -)
            MATRIX="{\"include\":[${MATRIX_ITEMS}]}"
            echo "Services to deploy: $DEPLOY_SERVICES"
          fi

          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT
          echo "Deployment matrix: ${MATRIX}"

  # å¹¶è¡Œéƒ¨ç½²
  deploy:
    needs: detect
    if: needs.detect.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      # ç¼“å­˜ mise å·¥å…·
      - name: Cache mise
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('mise.toml') }}

      # å®‰è£… mise
      - name: Install mise
        run: |
          curl https://mise.run | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # æ¿€æ´» mise çŽ¯å¢ƒ
      - name: Setup mise
        run: |
          mise install

      # ç¼“å­˜ pnpm storeï¼ˆæŒ‰ç…§æœ€ä½³å®žè·µï¼‰
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      # é…ç½® AWSï¼ˆç”¨äºŽ ECR å’Œ Parameter Storeï¼‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      # ä»Ž Parameter Store è¯»å–é…ç½®
      - name: Load configuration from Parameter Store
        id: load-config
        run: |
          echo "Loading configuration from AWS Parameter Store..."

          # è¯»å–éƒ¨ç½²é…ç½®
          DEPLOY_HOST=$(aws ssm get-parameter --name "/studio-prod/DEPLOY_HOST" --query "Parameter.Value" --output text)
          DEPLOY_USER=$(aws ssm get-parameter --name "/studio-prod/DEPLOY_USER" --query "Parameter.Value" --output text)
          DEPLOY_SSH_KEY=$(aws ssm get-parameter --name "/studio-prod/DEPLOY_SSH_KEY" --with-decryption --query "Parameter.Value" --output text)

          echo "DEPLOY_HOST=${DEPLOY_HOST}" >> $GITHUB_ENV
          echo "DEPLOY_USER=${DEPLOY_USER}" >> $GITHUB_ENV

          # ä¿å­˜ SSH key åˆ°æ–‡ä»¶
          mkdir -p ~/.ssh
          echo "${DEPLOY_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "âœ… Configuration loaded successfully"
          echo "   Host: ${DEPLOY_HOST}"
          echo "   User: ${DEPLOY_USER}"

      # ç™»å½• ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-west-2 | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      # é…ç½® SSH known_hosts
      - name: Setup SSH known_hosts
        run: |
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      # éƒ¨ç½²æœåŠ¡ï¼ˆä½¿ç”¨ repo ä¸­çš„ inventory.yml + çŽ¯å¢ƒå˜é‡æŒ‡å®š SSH keyï¼‰
      - name: Deploy ${{ matrix.service }}
        run: |
          mise run deploy-${{ matrix.service }}
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
          ANSIBLE_SSH_PRIVATE_KEY_FILE: ~/.ssh/id_rsa

      # éƒ¨ç½²ç»“æžœé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment summary
        if: always()
        run: |
          echo "### Deployment Result: ${{ matrix.service }} ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Service: \`${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
