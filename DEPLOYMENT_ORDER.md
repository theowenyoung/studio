# ğŸš€ éƒ¨ç½²é¡ºåºæŒ‡å—

å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é¡ºåºå’Œè¯´æ˜ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

1. âœ… æœåŠ¡å™¨å·²åˆå§‹åŒ–ï¼š`mise run server-init`
2. âœ… AWS å‡­è¯å·²é…ç½®ï¼šè‡ªåŠ¨åœ¨ server-init æ—¶å®Œæˆ
3. âœ… æœ¬åœ°å·²å®‰è£…ï¼š`ansible`, `boto3`, `docker`, `aws-cli`

---

## ğŸ”¢ æ ‡å‡†éƒ¨ç½²é¡ºåº

### 1ï¸âƒ£ éƒ¨ç½²åŸºç¡€è®¾æ–½æœåŠ¡

è¿™äº›æœåŠ¡æ˜¯å…¶ä»–åº”ç”¨çš„ä¾èµ–ã€‚

```bash
# éƒ¨ç½² PostgreSQL
mise run deploy-postgres

# éƒ¨ç½² Redis
mise run deploy-redis

# éƒ¨ç½² Caddy (åå‘ä»£ç†)
mise run deploy-caddy
```

æˆ–ä¸€é”®éƒ¨ç½²æ‰€æœ‰åŸºç¡€è®¾æ–½ï¼š

```bash
mise run deploy-infra
```

**ç­‰å¾…æ—¶é—´ï¼š** ~2-3 åˆ†é’Ÿ

---

### 2ï¸âƒ£ è¿è¡Œæ•°æ®åº“è¿ç§»

åœ¨éƒ¨ç½²åº”ç”¨ä¹‹å‰ï¼Œç¡®ä¿æ•°æ®åº“ schema æ˜¯æœ€æ–°çš„ã€‚

```bash
mise run db-migrate
```

**è¿™ä¸ªå‘½ä»¤ä¼šï¼š**
- æ„å»º db-adminï¼ˆå‡†å¤‡è¿ç§»è„šæœ¬å’Œé…ç½®ï¼‰
- ä» Parameter Store è·å–æ•°æ®åº“å‡­è¯
- ä½¿ç”¨ Ansible åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨çš„ç‰ˆæœ¬åŒ–ç›®å½•
- è¿è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»ï¼ˆdocker compose up --abort-on-container-exitï¼‰
- è‡ªåŠ¨é€€å‡ºï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰
- ä¿ç•™æœ€è¿‘ 3 ä¸ªç‰ˆæœ¬

**ç‰ˆæœ¬ç®¡ç†ï¼š**
- æ¯æ¬¡è¿ç§»ä½¿ç”¨æ—¶é—´æˆ³ç‰ˆæœ¬å·ï¼ˆå¦‚ 20251120143000ï¼‰
- é€šè¿‡ current è½¯é“¾æ¥æŒ‡å‘æœ€æ–°ç‰ˆæœ¬
- æ”¯æŒå¿«é€Ÿå›æ»šåˆ°ä¹‹å‰çš„è¿ç§»ç‰ˆæœ¬

**ç­‰å¾…æ—¶é—´ï¼š** ~30 ç§’

---

### 3ï¸âƒ£ éƒ¨ç½²åº”ç”¨æœåŠ¡

ç°åœ¨å¯ä»¥éƒ¨ç½²ä¾èµ–æ•°æ®åº“çš„åº”ç”¨ã€‚

```bash
# éƒ¨ç½² Hono Demo åº”ç”¨
mise run deploy-hono

# éƒ¨ç½² API æœåŠ¡ (å¦‚æœæœ‰)
mise run deploy-api
```

**éƒ¨ç½²è¿‡ç¨‹ä¼šè‡ªåŠ¨ï¼š**
1. æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° ECR
2. åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨çš„ç‰ˆæœ¬åŒ–ç›®å½•
3. **è‡ªåŠ¨è¿è¡Œåº”ç”¨çº§æ•°æ®åº“è¿ç§»**ï¼ˆä½¿ç”¨ node-pg-migrateï¼‰
4. å¯åŠ¨æˆ–æ›´æ–°åº”ç”¨å®¹å™¨
5. æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘ 3 ä¸ªï¼‰

**åº”ç”¨çº§è¿ç§»è¯´æ˜ï¼š**
- æ¯ä¸ªåº”ç”¨ï¼ˆå¦‚ hono-demoï¼‰å¯ä»¥æœ‰è‡ªå·±çš„æ•°æ®åº“è¿ç§»
- éƒ¨ç½²æ—¶ä¼šè‡ªåŠ¨è¿è¡Œ `pnpm migrate` æ›´æ–°åº”ç”¨çš„æ•°æ®åº“ schema
- å¦‚æœè¿ç§»å¤±è´¥ï¼Œéƒ¨ç½²ä¼šä¸­æ­¢ï¼Œç¡®ä¿æ•°æ®åº“å’Œä»£ç åŒæ­¥
- ä¹Ÿå¯ä»¥ä½¿ç”¨ `mise run migrate-hono` å•ç‹¬è¿è¡Œè¿ç§»ï¼ˆä¸é‡æ–°éƒ¨ç½²ï¼‰

**ç­‰å¾…æ—¶é—´ï¼š** æ¯ä¸ªåº”ç”¨ ~2-3 åˆ†é’Ÿ

---

### 4ï¸âƒ£ éƒ¨ç½²å¤‡ä»½æœåŠ¡

å¤‡ä»½æœåŠ¡åº”è¯¥åœ¨æ‰€æœ‰æ•°æ®æœåŠ¡è¿è¡Œåéƒ¨ç½²ã€‚

```bash
mise run deploy-backup
```

**å¤‡ä»½æœåŠ¡åŠŸèƒ½ï¼š**
- å®šæ—¶å¤‡ä»½ PostgreSQLï¼ˆæ¯å¤©å‡Œæ™¨ 2:00ï¼‰
- å®šæ—¶å¤‡ä»½ Redisï¼ˆæ¯å¤©å‡Œæ™¨ 3:00ï¼‰
- æ¸…ç†æ—§å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨ 5:00ï¼‰
- å®Œæ•´å¤‡ä»½ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨ 4:00ï¼‰

**ç­‰å¾…æ—¶é—´ï¼š** ~1-2 åˆ†é’Ÿ

---

### 5ï¸âƒ£ éƒ¨ç½²é™æ€ç«™ç‚¹ (å¯é€‰)

```bash
# éƒ¨ç½² Storefront
mise run deploy-storefront

# éƒ¨ç½² Blog
mise run deploy-blog
```

**ç­‰å¾…æ—¶é—´ï¼š** æ¯ä¸ªç«™ç‚¹ ~1 åˆ†é’Ÿ

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²é¡ºåº

å½“æ›´æ–°ç°æœ‰æœåŠ¡æ—¶ï¼Œåªéœ€è¦é‡æ–°éƒ¨ç½²å¯¹åº”çš„æœåŠ¡ï¼š

```bash
# æ›´æ–°å•ä¸ªåº”ç”¨ï¼ˆä¼šè‡ªåŠ¨è¿è¡Œè¿ç§»ï¼‰
mise run deploy-hono

# æ›´æ–°åŸºç¡€è®¾æ–½æœåŠ¡
mise run deploy-postgres
```

### å•ç‹¬è¿è¡Œåº”ç”¨è¿ç§»

å¦‚æœåªæƒ³è¿è¡Œæ•°æ®åº“è¿ç§»è€Œä¸é‡æ–°éƒ¨ç½²æ•´ä¸ªåº”ç”¨ï¼š

```bash
# åªè¿è¡Œ hono-demo çš„æ•°æ®åº“è¿ç§»
mise run migrate-hono

# åªè¿è¡Œ API çš„æ•°æ®åº“è¿ç§»
mise run migrate-api
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- æ•°æ®åº“ schema éœ€è¦æ›´æ–°ï¼Œä½†ä»£ç ä¸å˜
- æµ‹è¯•è¿ç§»è„šæœ¬
- å›æ»šåéœ€è¦é‡æ–°è¿è¡Œè¿ç§»

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
ssh deploy@your-server "docker ps"
```

### æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# æŸ¥çœ‹ PostgreSQL æ—¥å¿—
ssh deploy@your-server "docker logs current-postgres-1"

# æŸ¥çœ‹ Hono åº”ç”¨æ—¥å¿—
ssh deploy@your-server "docker logs current-hono-demo-1"

# æŸ¥çœ‹å¤‡ä»½æœåŠ¡æ—¥å¿—
ssh deploy@your-server "docker logs current-backup-1"
```

### é‡å¯æœåŠ¡

```bash
ssh deploy@your-server "cd /srv/studio/infra-apps/postgres/current && docker compose restart"
```

---

## ğŸ“ æœåŠ¡ä¾èµ–å…³ç³»

```
åŸºç¡€è®¾æ–½å±‚:
â”œâ”€â”€ postgres â† (æ— ä¾èµ–)
â”œâ”€â”€ redis â† (æ— ä¾èµ–)
â””â”€â”€ caddy â† (æ— ä¾èµ–)

åº”ç”¨å±‚:
â”œâ”€â”€ hono-demo â† depends on: postgres, redis
â”‚   â””â”€â”€ åº”ç”¨çº§è¿ç§»ï¼ˆnode-pg-migrateï¼Œè‡ªåŠ¨è¿è¡Œï¼‰
â”œâ”€â”€ api â† depends on: postgres, redis
â”‚   â””â”€â”€ åº”ç”¨çº§è¿ç§»ï¼ˆnode-pg-migrateï¼Œè‡ªåŠ¨è¿è¡Œï¼‰
â””â”€â”€ storefront (é™æ€ç«™ç‚¹) â† (æ— ä¾èµ–)

ç®¡ç†å±‚:
â”œâ”€â”€ db-admin â† depends on: postgres
â”‚   â””â”€â”€ åŸºç¡€ schema è¿ç§»ï¼ˆæ‰‹åŠ¨è¿è¡Œ mise run deploy-db-adminï¼‰
â””â”€â”€ backup â† depends on: postgres, redis
```

### æ•°æ®åº“è¿ç§»çš„ä¸¤ä¸ªå±‚æ¬¡

1. **åŸºç¡€ Schema è¿ç§»**ï¼ˆdb-adminï¼‰
   - åˆ›å»ºåŸºç¡€æ•°æ®åº“ç»“æ„ã€æ‰©å±•ã€æƒé™ç­‰
   - ä½¿ç”¨ `mise run deploy-db-admin` æ‰‹åŠ¨æ‰§è¡Œ
   - é€šå¸¸åœ¨é¦–æ¬¡éƒ¨ç½²æˆ–é‡å¤§ schema å˜æ›´æ—¶è¿è¡Œ

2. **åº”ç”¨çº§è¿ç§»**ï¼ˆå„åº”ç”¨çš„ migrationsï¼‰
   - æ¯ä¸ªåº”ç”¨ç®¡ç†è‡ªå·±çš„è¡¨ç»“æ„
   - ä½¿ç”¨ node-pg-migrate
   - **éƒ¨ç½²æ—¶è‡ªåŠ¨è¿è¡Œ**ï¼Œç¡®ä¿ä»£ç å’Œæ•°æ®åº“åŒæ­¥
   - ä¹Ÿå¯ä»¥å•ç‹¬è¿è¡Œï¼š`mise run migrate-hono`

---

## âš ï¸ é‡è¦æç¤º

1. **é¦–æ¬¡éƒ¨ç½²å¿…é¡»æŒ‰é¡ºåºè¿›è¡Œ**
   - å…ˆåŸºç¡€è®¾æ–½ â†’ å†è¿ç§» â†’ å†åº”ç”¨ â†’ æœ€åå¤‡ä»½

2. **db-admin æ˜¯ä¸€æ¬¡æ€§ä»»åŠ¡**
   - è¿è¡Œå®Œæˆåå®¹å™¨ä¼šè‡ªåŠ¨é€€å‡º
   - æ¯æ¬¡éœ€è¦è¿ç§»æ—¶é‡æ–°è¿è¡Œå³å¯

3. **å¤‡ä»½æœåŠ¡æŒç»­è¿è¡Œ**
   - éƒ¨ç½²åä¼šä¸€ç›´åœ¨åå°è¿è¡Œ
   - æŒ‰ cron è°ƒåº¦è‡ªåŠ¨æ‰§è¡Œå¤‡ä»½

4. **é›¶åœæœºéƒ¨ç½²ï¼ˆTODOï¼‰**
   - å½“å‰ä½¿ç”¨ `docker compose up -d`ï¼ˆæœ‰çŸ­æš‚åœæœºï¼‰
   - é…ç½® Traefik åå¯ä½¿ç”¨ `docker-rollout` å®ç°çœŸæ­£çš„é›¶åœæœº

5. **å¥åº·æ£€æŸ¥**
   - å¤§å¤šæ•°æœåŠ¡éƒ½é…ç½®äº† healthcheck
   - éƒ¨ç½²åç­‰å¾…æœåŠ¡å˜ä¸º healthy çŠ¶æ€å†ä½¿ç”¨

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒ

### å®Œæ•´é¦–æ¬¡éƒ¨ç½²

```bash
# 1. åˆå§‹åŒ–æœåŠ¡å™¨
mise run server-init

# 2. éƒ¨ç½²åŸºç¡€è®¾æ–½
mise run deploy-infra

# 3. è¿è¡Œæ•°æ®åº“è¿ç§»
mise run db-migrate

# 4. éƒ¨ç½²åº”ç”¨
mise run deploy-hono

# 5. éƒ¨ç½²å¤‡ä»½æœåŠ¡
mise run deploy-backup
```

### æ—¥å¸¸æ›´æ–°éƒ¨ç½²

```bash
# æ›´æ–°åº”ç”¨ä»£ç å
mise run deploy-hono

# æ·»åŠ æ–°è¿ç§»å
mise run db-migrate
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DEPLOYMENT.md](./DEPLOYMENT.md) - è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
- [README.md](./README.md) - é¡¹ç›®æ¦‚è§ˆ
- [infra-apps/backup/README.md](./infra-apps/backup/README.md) - å¤‡ä»½æœåŠ¡è¯¦ç»†æ–‡æ¡£
- [infra-apps/db-admin/README.md](./infra-apps/db-admin/README.md) - æ•°æ®åº“ç®¡ç†å·¥å…·æ–‡æ¡£
